/*
	This file is part of Bolixo.

	Bolixo is free software: you can redistribute it and/or modify
	it under the terms of the GNU General Public License as published by
	the Free Software Foundation, either version 3 of the License, or
	(at your option) any later version.

	Bolixo is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU General Public License for more details.

	You should have received a copy of the GNU General Public License
	along with Bolixo.  If not, see <https://www.gnu.org/licenses/>.
*/
#include <stdlib.h>
#include <ctype.h>
#include <unistd.h>
#include <string.h>
#include <sys/time.h>
#include <sys/resource.h>
#include <tlmpweb.h>
#include <tlmpnet.h>
#include <tlmplib.h>
#include <tlmpdoc.h>
#include <trlitool.h>
#include <string>
#include <algorithm>
#include <deque>
#define DEFINE_USERINFO
#include "util.h"
#include "../bolixo.h"
#include "../bolixo.m"
#include <tlmp/translat.h>
#include "document.h"
#include "../instrument.h"
#include "webtabs.h"

#define SECTION_NONE 0
#define SECTION_TALK 1
#define SECTION_PROJECT 2
#define SECTION_ACCOUNT 3
#define SECTION_GROUPS 4
#define SECTION_PROJECTS 5
#define SECTION_CONTACTS 6
#define SECTION_MAILS 7
#define SECTION_INTERESTS 8
#define SECTION_CONTACT_REQ 9
#define SECTION_PREVIEW 10
#define SECTION_NBSECTIONS 11
extern void bolixo_doc (DOCUMENT_POINTER &, DOC_ID &jump, const char *username, bool display_full);
extern void bolixo_doc_fr (DOCUMENT_POINTER &, DOC_ID &jump, const char *username, bool display_full);

static WEBID ID_TALK("talk");
static WEBID ID_MAIL("mail");
static WEBID ID_PROJECT("project");
static WEBID ID_CONTACT("contact");
static WEBID ID_PRJTEXT("prjtext");
static WEBID ID_INTERESTS("interests");
static WEBID ID_FOLLOW("follow");
#define TAB_FORM "tab_form"

using namespace std;

#include "../proto/bod_client.protoch"
#include "../proto/bo-sessiond_client.protoch"

static const char *newscolor = "#DCDCDC";

static USERINFO userinfo;
struct COPY{
	string name;	// Suggested base name
			// used for short messages
	string path;
	string date;
	void clear(){
		path.clear();
		date.clear();
		name.clear();
	}
};
const unsigned MENU_COPY=1;
const unsigned MENU_PASTE=2;
const unsigned MENU_DELETE=3;
const unsigned MENU_PREVIEW=4;
const unsigned MENU_HELPPREVIEW=5;
const unsigned MENU_UNDELETE=6;
const unsigned MENU_RENAME=7;
const unsigned MENU_DOWNLOAD=100;
static COPY fcopy;		// Cut buffer, holding a file path
static string w_session;
static W_SSTRING w_lang("lang");
static W_SSTRING w_public_dir("public_dir");
static W_UNSIGNED w_public_view("public_view");
static W_SSTRING w_dateformat("dateformat");
static W_UNSIGNED w_anon_messages("anonmsgs");

static W_SSTRING w_recipients("recipients");
static W_SSTRING w_folder("folder");
static W_SSTRING w_upload("upload");
static W_SSTRING w_accept("accept");
static W_SSTRING w_user("user");
static W_SSTRING w_list("list");
static W_SSTRING w_group("group");
static W_UNSIGNED w_add("add");
static W_SSTRING w_desc("desc");
static W_SSTRING w_group1("group1");
static W_SSTRING w_group2("group2");
static W_SSTRING w_group3("group3");
static W_SSTRING w_group4("group4");
static W_SSTRING w_access1("access1");
static W_SSTRING w_access2("access2");
static W_SSTRING w_access3("access3");
static W_SSTRING w_access4("access4");

static W_SSTRING w_name("name");
static W_SSTRING w_image("image");
extern W_SSTRING w_webtable;
static map<string,unsigned> offsets;
static map<string,unsigned> currents;

static W_UNSIGNED w_publish("publish");
static W_UNSIGNED w_bosite("bosite");
static W_UNSIGNED w_photo("photo");
static W_UNSIGNED w_miniphoto("miniphoto");
static W_SSTRING w_address1("address1");
static W_SSTRING w_address2("address2");
static W_SSTRING w_city("city");
static W_SSTRING w_state("state");
static W_SSTRING w_country("country");
static W_SSTRING w_zipcode("zipcode");
static W_SSTRING w_phone("phone");
static W_SSTRING w_fax("fax");
static W_SSTRING w_website("website");
static W_SSTRING w_interest("interest");

static void index_field (_F_form *c, bool newline,unsigned colspan, const char *title, W_SSTRING &var, unsigned size)
{
	if (newline) htmlout ("<tr>");
	htmlprintf ("<td>%s<td colspan=%u>\n",title,colspan);
	char tmp[100];
	snprintf (tmp,sizeof(tmp),"size=%u",size);
	c->field_string (var,tmp);
}
static void index_field (_F_form *c, bool newline, const char *title, W_SSTRING &var)
{
	index_field (c,newline,1,title,var,25);
}
static map<string,WEBTAB_CTRL> tabs;
void webtab_init (const vector<SNAMEVAL_receive> &vals)
{
	for (auto &s:vals){
		// Split the name
		const char *pt = strchr(s.sname,':');
		if (pt != NULL){
			WEBTAB_CTRL &ctrl = tabs[string(s.sname,pt)];
			if (strcmp(pt,":0")==0){
				vector<string> tb;
				int n = str_splitline(s.sval,',',tb);
				if (n == 4){
					for (unsigned i=0; i<4; i++){
						ctrl.offsets[i] = atoi(tb[i].c_str());
					}
				}
			}else{
				ctrl.tabs.push_back(WEBTAB(pt+1,s.sval));
			}
		}
	}
}

static W_UNSIGNED w_order ("order");
static unsigned order = 0;
static W_UNSIGNED w_test("test");
extern W_UNSIGNED w_robot;
static W_SSTRING w_email("email");
static W_SSTRING w_password("password");

static W_SSTRING new_nickname("nickname");
static W_SSTRING new_email ("new_email");
static W_SSTRING new_password1 ("new_password1");
static W_SSTRING new_password2 ("new_password2");

static W_SSTRING w_content("content");
static W_SSTRING w_filename("filename");
static W_SSTRING w_confirm("confirm");

#include "steps.h"

static string toupper (const char *s)
{
	string ret;
	while (*s != '\0'){
		ret += toupper(*s);
		s++;
	}
	return ret;
}
struct _F_sendfile_common {
	string handle;
	bool success;
	void sethandle (PARAM_STRING handle);
	void setresult (bool success, PARAM_STRING msg);
};
void _F_sendfile_common::sethandle (PARAM_STRING _handle)
{
	handle = _handle.ptr;
}
void _F_sendfile_common::setresult (bool _success, PARAM_STRING msg)
{
	success = _success;
	if (!success) htmlprintf ("sendfile failed: %s<br>\n",msg.ptr);
}

#define _TLMP_sendfile
struct _F_sendfile: public _F_sendfile_common {
	#define _F_sendfile_start(x) void x start(const char *filepath, const BOB_TYPE &content, bool more)
	virtual _F_sendfile_start( )=0;
	#define _F_sendfile_rest(x) void x rest(const string &handle, const BOB_TYPE &content, bool more)
	virtual _F_sendfile_rest( )=0;
};

static void sendfile(_F_sendfile &c, PARAM_STRING filepath, PARAM_STRING localfile, bool &fail)
{
	c.success = true;
	FILE *fin = fopen (localfile.ptr,"r");
	if (fin == NULL){
		htmlprintf ("Internal error reading temp file: :%s:<br>\n",localfile.ptr);
		fail = true;
	}else{
		char buf[40000];
		size_t nb = fread (buf,1,sizeof(buf),fin);
		bool more = (nb == sizeof(buf));
		c.start (filepath.ptr,BOB_TYPE(buf,nb,false),more);
		if (more && c.success){
			if (c.handle.empty()){
				tlmp_error ("sendfile: handle is empty for file %s\n",filepath.ptr);
				htmlprintf ("Internal error, sendfile has not handle<br>\n");
			}else{
				while (more && c.success){
					nb = fread (buf,1,sizeof(buf),fin);
					more = (nb == sizeof(buf));
					c.rest (c.handle,BOB_TYPE(buf,nb,false),more);
				}
			}
		}
		fclose (fin);
	}
	if (!c.success) fail = true;
}
#define _TLMP_sendfile_var
struct _F_sendfile_var: public _F_sendfile_common {
	#define _F_sendfile_var_start(x) void x start(const char *filepath, const BOB_TYPE &content, bool more)
	virtual _F_sendfile_var_start( )=0;
	#define _F_sendfile_var_rest(x) void x rest(const string &handle, const BOB_TYPE &content, bool more)
	virtual _F_sendfile_var_rest( )=0;
};
static void sendfile_var(_F_sendfile_var &c, PARAM_STRING filepath, const W_SSTRING &var_content, bool &fail)
{
	const char *content = var_content.c_str();
	c.success = true;
	unsigned len = strlen(content);
	unsigned nb = len;
	bool more = false;
	if (nb > 40000){
		nb = 40000;
		more = true;
	}
	c.start (filepath.ptr,BOB_TYPE(content,nb,false),more);
	if (more && c.success){
		if (c.handle.empty()){
			tlmp_error ("sendfile: handle is empty for file %s\n",filepath.ptr);
			htmlprintf ("Internal error, sendfile has not handle<br>\n");
		}else{
			unsigned offset = nb;
			while (offset < len && c.success){
				nb = len - offset;
				more = false;
				if (nb > 40000){
					nb = 40000;
					more = true;
				}
				c.rest (c.handle,BOB_TYPE(content+offset,nb,false),more);
				offset += nb;
			}
		}
	}
	if (!c.success) fail = true;
}
	
static bool is_mobile = false;
static bool private_site = false;

static void show_buttons_right(_F_websteps *c)
{
	//int step = c->getcurstep();
	/- <table border=0 cellspacing=0>
	/- <tr>
		
	unsigned fontsize = is_mobile ? 3 : 1;	// size=+fontsize
	bool is_user = userinfo.name.size() > 0;
	if (!is_user){
		/- <td>&nbsp;
		/- <td>
		htmlprintf ("<a href=%s?webstep=%d><font size=+%u>%s</font></a>\n",tlmpweb_curpage(),step_login,fontsize,MSG_U(I_LOGIN,"Login"));
		if (!private_site){
			/- <td>&nbsp;
			/- <td align=center>
			htmlprintf ("<font size=+%u color=black>%s</font>",fontsize,MSG_U(I_OR,"or"));
			/- <td>&nbsp;
			/- <td>
			htmlprintf ("<a href=%s?webstep=%d><font size=+%u>%s</font></a>\n",tlmpweb_curpage(),step_adduser,fontsize,MSG_U(I_CREATEACCT,"Create account"));
		}
	}
	if (0 && userinfo.is_admin){
		/- <td>
		string tmp = string_f ("href=%s/admin.hc",tlmpweb_curdir());
		print_href("Admin menu",tmp);
	}
	if (is_user){
		if (!is_mobile){
			/- <td>
			htmlprintf ("<font size=+%u color=gray>\n",fontsize);
			htmlprintf (MSG_U(I_WELCOME,"Welcome %s"),userinfo.name.c_str());
			int nb = 40 - userinfo.name.size() - 8; 
			for (int i=0; i<nb; i++){
				htmlprintf ("&nbsp;");
			}
			/- </font>
			/- <td>&nbsp;
		}
		/- <td>
		// PATCH: The <br> is there to avoid a vertical scroll bar. No idea why
		htmlprintf ("<a href=%s?webstep=%d><font size=+%u>%s</font><br>&nbsp;</a>\n",tlmpweb_curpage(),step_logout,fontsize,MSG_U(I_LOGOUT,"Logout"));
	}
	/- </table>
}


static unsigned subject = 0;
const unsigned max_subject=7;

static void print_button (const char *title, int step, int curstep)
{
	if (step == curstep){
		print_aref_selected (title,step);
	}else{
		print_aref (title,step);
	}
}
struct CURRENTFORM{
	string id;
	vector<string> vars;
};
static vector<CURRENTFORM> currentforms;
static string org("Bolixo.org");
<mod>
static void bolixo_title (const char *title, _F_websteps *c)
{
	glocal int step = c->getcurstep();

	string tmp = string_f ("Bolixo: %s",title);
	tlmpweb_title (tmp.c_str());
	util_google_code();
	util_defstyles();
	tlmpweb_body("white",NULL);
	
	DIV main; main.id("main").h(100).w(100).dispflex().flowcol().print();
	DIV head; head.id("head").flexfixe().print();
	/- <table border=0 width=100% cellpadding=0 cellspacing=0>
	htmlprintf ("<table border=0 width=100%% bgcolor=%s cellspacing=0 cellpadding=0><tr><td rowspan=2 align=left>\n",newscolor);
	if (is_mobile){
		/- <font color=gray>
		htmlprintf (MSG_U(I_NODENAME,"Node %s"),util_getnodename());
		/- </font>
	}else{
		/- <table border=0><tr><td><img height=20 src=/favicon.ico></td><td align=left>
		htmlprintf ("<a href=%s><font size=7 color=\"white\">%s</font></a>&nbsp;&nbsp;&nbsp;",util_getdirserver(),org.c_str());
		/- <font color=gray>
		htmlprintf (MSG_R(I_NODENAME),util_getnodename());
		/- </font>
		/- <td>
		if (userinfo.name.empty()) htmlout (MSG_U(I_ABOUT,"<font color=white>A peer to peer open social media</font>"));
		/- </table>
		/- </td>
	}
	/- <td align=right valign=top>
	show_buttons_right (c);
	/- </td></tr>
	/- <tr><td align=right valign=bottom>
	if (w_robot == 0 && userinfo.name.size() > 0){
		<call button_row>(0,newscolor,false);
		<f draw>
			split();
			print_button (MSG_U(M_MAIN,"Main"),1,glocal.step);
			split();
			print_button (MSG_U(M_TALK,"Talk"),step_talks,glocal.step);
			#if 0
			split();
			print_button (MSG_U(M_MAIL,"Mail"),step_mails,glocal.step);
			#endif
			split();
			print_button (MSG_U(M_PROJECTS,"Projects"),step_projects,glocal.step);
			if (!is_mobile){
				split();
				print_button (MSG_U(M_PROFILE,"Profile"),step_profile,glocal.step);
				split();
				print_button (MSG_U(M_DOCUM,"Documentation"),step_doc,glocal.step);
			}
		</f>
		</call>
	}
	/- </tr></table>
	/- </table>
	head.end();
	DIV body; body.id("body").flexfixe().print();
	body.donotend();
	main.donotend();
}
</mod>
<mod>
static bool valid_context (CONNECT_INFO &con, _F_websteps *c, const char *subject, bool check_news, bool check_proof)
{
	glocal bool ret = true;
	if (userinfo.name.empty()){
		bolixo_title ("",c);
		/- <p>You must be logged to
		printf ("%s<p>\n",subject);
		/- You do not have an account, just create one (top right button).
		/- <br>
		/- It takes one minute.
		/- <p>
		/- See the 
		printhref_raw ("/terms-of-use.html","terms of use",false);
		/- &nbsp;for more details.
		glocal.ret = false;
	}
	return glocal.ret;
}
</mod>

static void trli_initvar (VAR &var, PARAM_STRING name, PARAM_STRING val)
{
	var.name = name.ptr;
	SNAMEVAL sval;
	sval.sval = val.ptr;
	var.vals.push_back(sval);
}

<mod>
static void trli_getsessioninfo(CONNECT_INFO &con, CONNECT_INFO &con_sess, vector<DOCUMENT_POINTER> &docpointers)
{
	glocal CONNECT_INFO *con = &con;
	glocal vector<DOCUMENT_POINTER> *docpointers = &docpointers;
	<call bo_sessiond_client_getsessioninfovars>(con_sess,w_session.c_str());
	<f ok>
		if (success){
			userinfo.lang = lang;
			if (lang[0] != '\0'){
				translat_selectlang (lang);
			}else{
				userinfo.lang = tlmpweb_getlang();
			}
			userinfo.name = name;
			userinfo.dateformat = dateformat;
			userinfo.is_admin = admin;
			fcopy.clear();
			for (auto &var:vars){
				if (strcmp(var.name,"subject")==0 && var.vals.size()==1) subject=atoi(var.vals[0].sval);
				if (strcmp(var.name,"order")==0 && var.vals.size()==1) order=atoi(var.vals[0].sval);
				if (strcmp(var.name,"offsets")==0){
					for (auto &s:var.vals) offsets[s.sname] = atoi(s.sval);
				}else if (strcmp(var.name,"currents")==0){
					for (auto &s:var.vals) currents[s.sname] = atoi(s.sval);
				}else if (strcmp(var.name,"webtabs")==0){
					webtab_init (var.vals);
				}else if (strcmp(var.name,"document")==0){
					// Several document pointers are stored in sequence, repeating the same variable names
					unsigned nodoc = 0;
					unsigned s1=0,s2=0,s3=0,s4=0;
					for (auto &v:var.vals){
						if (strcmp(v.sname,"s1")==0){
							s1 = atoi(v.sval);
						}else if (strcmp(v.sname,"s2")==0){
							s2 = atoi(v.sval);
						}else if (strcmp(v.sname,"s3")==0){
							s3 = atoi(v.sval);
						}else if (strcmp(v.sname,"s4")==0){
							s4 = atoi(v.sval);
							while (nodoc >= glocal.docpointers->size()) glocal.docpointers->push_back(DOCUMENT_POINTER());
							(*glocal.docpointers)[nodoc].set(s1,s2,s3,s4);
							(*glocal.docpointers)[nodoc].resetchanged();
							nodoc++;
						}
					}
						
				}else if (strcmp(var.name,"currentform")==0){
					CURRENTFORM form;
					for (auto &v:var.vals){
						if (strcmp(v.sname,"id")==0){
							if (form.id.size()>0){
								currentforms.push_back(form);
							}
							form.id = v.sval;
							form.vars.clear();
						}else if (strcmp(v.sname,"var")==0){
							form.vars.push_back(v.sval);
						}
					}
					if (form.id.size()>0){
						currentforms.push_back(form);
					}
				}else if (strcmp(var.name,"geometry")==0){
					// We receive triplets: id,height,width
					WEBID id;
					unsigned height=0;
					for (auto &v:var.vals){
						if (strcmp(v.sname,"id")==0){
							id.set(v.sval);
						}else if (strcmp(v.sname,"height")==0){
							height = atoi(v.sval);
						}else if (strcmp(v.sname,"width")==0){
							tlmpweb_settablegeometry(id,height,atoi(v.sval));
						}
					}
				}else if (strcmp(var.name,"copy")==0){
					for (auto &v:var.vals){
						if (strcmp(v.sname,"path")==0){
							fcopy.path = v.sval;
						}else if (strcmp(v.sname,"date")==0){
							fcopy.date = v.sval;
						}else if (strcmp(v.sname,"name")==0){
							fcopy.name = v.sval;
						}
					}
				}
			}
			// Refresh the cookie so it is valid for 2 more days
			websession_setcookie("session",w_session.c_str(),time(NULL)+48*60*60);
		}else{
			userinfo.reset();
			<call bod_client_createsession>(*glocal.con);
			<f ok>
				w_session = sessionid;
				websession_setcookie("session",sessionid,time(NULL)+48*60*60);
			</f>
			</call>
		}
	</f>
	</call>
}
</mod>
static void index_doc (DOCUMENT_POINTER &pt, DOC_ID &jump)
{
	if (userinfo.lang == "fr"){
		bolixo_doc_fr(pt,jump,userinfo.name.c_str(),w_robot);
	}else{
		bolixo_doc (pt,jump,userinfo.name.c_str(),w_robot);
	}
}

static void button_validate(int step)
{
	htmlprintf ("<input type=\"submit\" value=\"Validate\" formaction=\"%s?webstep=%d&validate=1\">\n"
		,tlmpweb_curpage(),step);
}

<mod>
static void web_updateoffsets(CONNECT_INFO &con_sess)
{
	VAR var;
	var.name = "offsets";
	for (auto &v:offsets){
		SNAMEVAL val;
		val.sname = v.first;
		val.sval = string_f ("%u",v.second);
		var.vals.push_back(val);
	}
	//tlmp_error ("updateoffsets\n");
	<call bo_sessiond_client_setvar>(con_sess,w_session.c_str(),var);
	<f ok>
		if (!success) tlmp_error ("Can't set variable offset: %s\n",msg);
	</f>
	</call>
}
</mod>
<mod>
static void web_updatecurrents(CONNECT_INFO &con_sess)
{
	VAR var;
	var.name = "currents";
	for (auto &v:currents){
		SNAMEVAL val;
		val.sname = v.first;
		val.sval = string_f ("%u",v.second);
		var.vals.push_back(val);
	}
	//tlmp_error ("updatecurrents\n");
	<call bo_sessiond_client_setvar>(con_sess,w_session.c_str(),var);
	<f ok>
		if (!success) printf ("Can't set variable current: %s\n",msg);
	</f>
	</call>
}
</mod>
/*
	Format an <img tag
*/
static string index_img(unsigned step, unsigned width, PARAM_STRING dirpath, PARAM_STRING filename, PARAM_STRING date)
{
	string tmp = util_flipspaces(date);
	const char *sep = "/";
	if (dirpath.ptr[0] == '\0') sep = "";
	return string_f ("<img width=%u src=%s?webstep=%u&image=%s%s%s&mod=%s>"
		,width,tlmpweb_curpage(),step,dirpath.ptr,sep,filename.ptr,tmp.c_str());
}
static string index_img(unsigned step, const char *style, PARAM_STRING filepath, PARAM_STRING date)
{
	string tmp = util_flipspaces(date);
	return string_f ("<img width=100%% style='%s' src=%s?webstep=%u&image=%s&mod=%s>"
		,style,tlmpweb_curpage(),step,filepath.ptr,tmp.c_str());
}

<mod>
static int index_loadfile(CONNECT_INFO &con, PARAM_STRING filename, string &text)
{
	glocal CONNECT_INFO *con = &con;
	glocal string *text = &text;
	glocal int ret = 0;
	text.clear();
	<call bod_client_readfile_bob>(con,w_session.c_str(),filename,"",false);
	<f ok>
		if (!success){
			htmlprintf ("Can't read file: %s\n",msg);
			glocal.ret = -1;
		}else{
			(*glocal.text) = string((const char*)content.getbuffer(),content.getsize());
			glocal bool more = more;
			while (glocal.more && glocal.ret != -1){
				<call bod_client_readmore>(*glocal.con,w_session.c_str(),handle);
				<f ok>
					if (!success){
						glocal.ret = -1;
						htmlprintf ("Can't read file: %s\n",msg);
					}else{
						(*glocal.text) += string((const char*)content.getbuffer(),content.getsize());
					}
					glocal.more = more;
				</f>
				</call>
			}	
		}
	</f>
	</call>
	return glocal.ret;
}
</mod>

static int index_loadfile(CONNECT_INFO &con, PARAM_STRING filename, W_SSTRING &text)
{
	string tmp;
	int ret = index_loadfile(con,filename,tmp);
	text = tmp;
	return ret;
}


static void index_format_large_text(const BOB_TYPE &content)
{
	string tmp = string((const char*)content.getbuffer(),content.getsize());
	tmp = util_format_shortmsg (tmp.c_str());
	htmlwrite (tmp.c_str(),tmp.size());
}
<mod>
static void index_popup (CONNECT_INFO &con, int step, const char *content, FILE_TYPE file_type, PARAM_STRING modified, PARAM_STRING filepath)
{
	glocal CONNECT_INFO *con = &con;
	const char *path = filepath.ptr;
	tlmpweb_body("white",NULL);
	if (content[0] != '\0'){
		htmlout (util_format_shortmsg (content,10000).c_str());
	}else if (file_is_sound(file_type)){
		htmlprintf ("<audio controls>\n"
			"<source src=\"%s?webstep=%u&image=%s\" type=\"audio/%s\">\n"
			"</audio>"
			,tlmpweb_curpage(),step,path,tbftype[file_type]);
	}else if (file_is_video(file_type)){
		htmlprintf ("<video width=\"800\" height=\"600\" controls>\n"
			"<source src=\"%s?webstep=%u&image=%s\" type=\"video/mp4\">\n"
			"Your browser does not support the video tag.\n"
			"</video>\n"
			,tlmpweb_curpage(),step,path);
	}else if (file_is_image(file_type)){
		string img = index_img (step,"",path,modified);
		htmlout (img);
	}else if (file_is_text(file_type)){
		<call bod_client_readfile_bob>(con,w_session.c_str(),path,"",false);
		<f ok>
			if (!success){
				htmlprintf ("Can't read file: %s\n",msg);
			}else{
				index_format_large_text (content);
				glocal bool more = more;
				while (glocal.more){
					<call bod_client_readmore>(*glocal.con,w_session.c_str(),handle);
					<f ok>
						index_format_large_text (content);
						glocal.more = more;
					</f>
					</call>
				}	
			}
		</f>
		</call>
	}
}
</mod>
static void index_popup (CONNECT_INFO &con, const char *content, FILE_TYPE file_type, PARAM_STRING modified, PARAM_STRING filepath)
{
	index_popup (con,step_image,content,file_type,modified,filepath);
}
<mod>
static void index_markview (CONNECT_INFO &con, PARAM_STRING fname)
{
	<call bod_client_markview>(con,w_session.c_str(),fname);
	<f ok>
	</f>
	</call>
}
</mod>
<mod>
static ENTRY_TYPE index_entrytype(CONNECT_INFO &con,PARAM_STRING path, FILEINFO &info)
{
	glocal FILEINFO *info = &info;
	<call bod_client_stat>(con,w_session.c_str(),path,"");
	<f ok>
		(*glocal.info) = file;
	</f>
	</call>
	return info.type;
}
</mod>
static ENTRY_TYPE index_entrytype(CONNECT_INFO &con,PARAM_STRING path)
{
	FILEINFO info;
	return index_entrytype(con,path,info);
}
<mod>
static int index_paste_copy (CONNECT_INFO &con, PARAM_STRING newfname)
{
	glocal int ret = -1;
	//htmlprintf ("pasting %s %s -> %s<br>\n",fcopy.path.c_str(),fcopy.date.c_str(),newfname.c_str());
	<call bod_client_copy> (con,w_session.c_str(),fcopy.path,fcopy.date,newfname);
	<f ok>
		if (!success){
			htmlprintf (MSG_U(E_CANTPASTEENTRY,"Can't paste: %s<br>\n"),msg);
		}else{
			glocal.ret = 0;
		}
	</f>
	</call>
	return glocal.ret;
}
<mod>
static void index_paste(CONNECT_INFO &con, PARAM_STRING path)
{
	if (fcopy.path.size() == 0){
		htmlprintf (MSG_U(E_NOTHINGTOPASTE,"Nothing to paste: fcopy.path = %s<br>\n"),fcopy.path.c_str());
	}else{
		glocal const char *path = path.ptr;
		glocal CONNECT_INFO *con = &con;
		glocal string newfname = string_f("%s/%s",path.ptr,fcopy.name.c_str());
		ENTRY_TYPE type = index_entrytype(con,glocal.newfname);
		if (type != ENTRY_NONE){
			<call form>("pasterename");
			<f setup>
				/- <table border=0>
				/- <tr><td>
				htmlout (MSG_R(F_OLDNAME));
				/- <td>
				htmlout(fcopy.name);
				/- <tr><td>
				htmlout (MSG_R(F_NEWNAME));
				/- <td>
				field_string (w_name,"");
				/- </table>
			</f>
			<f validate>
				bool ret = true;
				glocal.newfname = string_f("%s/%s",glocal.path,w_name.c_str());
				if (index_entrytype(*glocal.con,glocal.newfname) != ENTRY_NONE){
					htmlprintf (MSG_U(E_NAMEEXIST,"FIle or folder name %s already exist"),w_name.c_str());
					ret = false;
				}
				return ret;
			</f>
			<f process>
				if (index_paste_copy (*glocal.con,glocal.newfname)==-1){
					fail = true;
				}
			</f>
			</call>
		}else{
			index_paste_copy (con,glocal.newfname);
		}
	}
}
</mod>
<mod>
static void index_paste(CONNECT_INFO &con, PARAM_STRING path, PARAM_STRING groupowner, PARAM_STRING group)
{
	if (fcopy.path.size()==0){
		htmlprintf (MSG_R(E_NOTHINGTOPASTE),fcopy.path.c_str());
	}else{
		static vector<string> empty;
		<call bod_client_sendtalk_file> (con,w_session.c_str(),"",empty,group,groupowner,fcopy.path,fcopy.date);
		<f ok>
			if (!success) htmlprintf (MSG_R(E_CANTPASTEENTRY),msg);
		</f>
		</call>
	}
}
</mod>
// Set the MENU_PASTE menu, make it gray out sens
static void index_setpastemenu (_F_webtable *c, PARAM_STRING path)
{
	bool disable = false;
	string paste = MSG_U(M_PASTE,"Paste");
	if (fcopy.path.size()==0){
		disable = true;	// Nothing to paste
	}else{
		#if 0
		if (fcopy.path == path.ptr){
			disable = true;	// Pasting on itself
		}else{
			size_t size = strlen(path.ptr);
			if (strncmp(fcopy.path.c_str(),path.ptr,size)==0){
				// Check if copypath come from the directory path
				const char *pt = fcopy.path.c_str()+size;
				if (pt[0] == '/'){
					pt = strchr(pt+1,'/');
					if (pt == NULL){
						// copypath is a file or folder member of path
						disable = true;
					}
				}
			}
		}
		#endif
		paste = string_f("%s %s",MSG_R(M_PASTE),fcopy.name.c_str());
	}
	c->adddrop_opt (MENU_PASTE,paste);
	if (disable) c->setdrop_disable(MENU_PASTE);
}
<mod>
static void index_setcopyitem(CONNECT_INFO &con_sess, PARAM_STRING path, PARAM_STRING modified, PARAM_STRING name)
{
	VAR var;
	var.name = "copy";
	SNAMEVAL val;
	val.sname = "path";
	val.sval = path.ptr;
	var.vals.push_back(val);

	val.sname = "date";
	val.sval = modified.ptr;
	var.vals.push_back(val);

	val.sname = "name";
	val.sval = name.ptr;
	var.vals.push_back(val);
	//tlmp_error ("setcopyitem setvar\n");
	<call bo_sessiond_client_setvar>(con_sess,w_session.c_str(),var);
	<f ok>
		if (!success) tlmp_error ("Can't set variable copy: %s\n",msg);
	</f>
	</call>
	fcopy.path = path.ptr;
	fcopy.date = modified.ptr;
	fcopy.name = name.ptr;
}
</mod>

/*
	Define a meaningful filename for a short message
*/
static void index_msg_name (FILE_TYPE file_type, string &filename, string &extension)
{
	// Message do not have a meaningful filename, so we invent something
	filename = MSG_U(I_BOLIXOMESSAGE,"bolixomessage");
	extension = "txt";
	if (file_is_sound(file_type)){
		filename=MSG_U(I_BOLIXOAUDIO,"bolixoaudio");
		if (file_type == FILE_SOUND_MP3){
			extension = "mp3";
		}else if (file_type == FILE_SOUND_OGG){
			extension = "ogg";
		}
	}else if (file_is_image(file_type)){
		filename=MSG_U(I_BOLIXOIMAGE,"bolixoimage");
		if (file_type == FILE_IMAGE_JPG){
			extension = "jpg";
		}else if (file_type == FILE_IMAGE_GIF){
			extension = "gif";
		}else if (file_type == FILE_IMAGE_PNG){
			extension = "png";
		}
	}else if (file_is_video(file_type)){
		filename=MSG_U(I_BOLIXOVIDEO,"bolixovideo");
		extension = "mp4";
	}
}
static void index_download (CONNECT_INFO &con, FILE_TYPE file_type, PARAM_STRING fname)
{
	string filename,extension;
	index_msg_name(file_type,filename,extension);
	tlmpweb_header ("Content-Disposition"," attachment; filename=%s.%s",filename.c_str(),extension.c_str());
	util_sendfile (con,w_session.c_str(),fname);
}

<mod>
static void index_show_shortmsg(
	CONNECT_INFO &con,
	CONNECT_INFO &con_sess,
	_F_webtabs &webtabs,
	const string &table,
	PARAM_STRING groupname,
	PARAM_STRING groupowner)
{
	glocal _F_webtabs *webtabs = &webtabs;
	glocal CONNECT_INFO *con = &con;
	glocal CONNECT_INFO *con_sess = &con_sess;
	glocal const char *groupname = groupname.ptr;
	glocal const char *groupowner = groupowner.ptr;
	glocal string path = string_f("/msgs/%s/short-inbox/%s",glocal.groupowner,glocal.groupname);
	if (offsets[table] == 0){
		index_markview (con,glocal.path);
	}
	<call webtable>(ID_TALK,table,"100%",currents[table],offsets[table],5);
	<f click>
		glocal unsigned dropmenu = dropmenu;
		if (dropmenu == 0) tlmpweb_flushheader();
		if (dropmenu == MENU_UNDELETE){
			<call bod_client_undelete> (*glocal.con,w_session.c_str(),glocal.path);
			<f ok>
				if (!success) htmlprintf (MSG_R(E_CANTUNDELETEENTRY),msg);
			</f>
			</call>
		}else if (dropmenu == MENU_PASTE){
			index_paste (*glocal.con,glocal.path,glocal.groupowner,glocal.groupname);
		}else{
			<call bod_client_list_talk>(*glocal.con,w_session.c_str(),"",glocal.groupname,glocal.groupowner,noline,1);
			<f ok>
				if (messages.size()!=1){
					htmlprintf ("Internal error: %s\n",msg);
				}else{
					auto &m = messages[0];
					glocal string fname = string_f("%s/%s",glocal.path.c_str(),m.uuid);
					glocal string suggested_name;
					string filename,extension;
					index_msg_name (m.file_type,filename,extension);
					glocal.suggested_name = filename + "." + extension;
					if (glocal.dropmenu == MENU_DELETE){
						<call bod_client_delfile> (*glocal.con,w_session.c_str(),glocal.fname);
						<f ok>
							if (!success){
								htmlprintf (MSG_R(E_CANTDELETEENTRY),msg);
							}else{
								index_setcopyitem(*glocal.con_sess,glocal.fname,"",glocal.suggested_name);
							}
						</f>
						</call>
					}else if (glocal.dropmenu == MENU_COPY){
						index_setcopyitem(*glocal.con_sess,glocal.fname,"",glocal.suggested_name);
					}else if (glocal.dropmenu == MENU_DOWNLOAD){
						index_download (*glocal.con,m.file_type,glocal.fname);
					}else{
						//htmlprintf ("uuid=%s<p>\n",m.uuid);
						index_popup (*glocal.con,m.content,m.file_type,m.submit
							,string_f("/msgs/%s/short-inbox/%s/%s"
							,glocal.groupowner,glocal.groupname,m.uuid));
					}
				}
			</f>
			</call>
		}
	</f>
	<f load>
		// Defines all posible options for dropdown
		adddrop_opt (MENU_COPY,MSG_R(M_COPY));
		index_setpastemenu(this,glocal.path);
		adddrop_opt (MENU_DELETE,MSG_R(M_DELETE));
		adddrop_opt (MENU_UNDELETE,MSG_R(M_UNDELETE));
		adddrop_opt (MENU_DOWNLOAD,MSG_R(M_DOWNLOAD));
		glocal unsigned rownum = nbskip;
		sethead (MSG_U(H_TALK,"From\t\tSubmit\tMessage"));
		<call bod_client_list_talk>(*glocal.con,w_session.c_str(),"",glocal.groupname,glocal.groupowner,nbskip,nblines);
		<f ok>
			glocal.webtable.setdrop_default({MENU_PASTE});
			if (!success){
				//htmlprintf ("Error: %s %s<br>",internal_error?"Internal error":"",msg);
			}else{
				string day;
				static const char *line_styles[]={"sep","sep1"};
				unsigned line_style = 0;
				if (!deletes) glocal.webtable.setdrop_disable(MENU_UNDELETE);
				unsigned image_width = 200;
				unsigned mini_image_width = 30;
				unsigned video_size = 200;
				if (is_mobile){
					image_width = 300;
					mini_image_width = 60;
					video_size = 300;
				}
				for (auto &m:messages){
					string now = string(m.submit,10);
					if (now != day){
						day = now;
						glocal.webtable.setclickopt (true,"","");
						glocal.webtable.setdrop_visibles({MENU_PASTE});
						glocal.webtable.setrow("hline",-1,"<div id=date0_7b>%s</div>\a\a\a",format_date(userinfo.dateformat,day).c_str());
						glocal.webtable.resetdrop();
						line_style=0;
					}
					const char *func = "Popup";
					string path = string_f("/msgs/%s/short-inbox/%s/%s",glocal.groupowner,glocal.groupname,m.uuid);
					if (glocal.webtabs->selected(path)) glocal.webtable.setcurrent(glocal.rownum);
					if (file_is_sound(m.file_type)){
						glocal.webtable.setclickopt (true,func,"400,100");
					}else if (file_is_video(m.file_type)){
						glocal.webtable.setclickopt (true,func,"800,800");
					}else if (file_is_image(m.file_type)){
						glocal.webtable.setclickopt (true,"",string_f("webtab_add=2:%s~%s",path.c_str(),"image"));
					}else if (file_is_text(m.file_type)){
						glocal.webtable.setclickopt (true,"",string_f("webtab_add=2:%s~%s",path.c_str(),"text"));
					}
					string content;
					if (m.content[0] != '\0'){
						content = string_f("<div class=smsg>%s</div>",util_format_shortmsg (m.content,5).c_str());
					}else if (file_is_sound(m.file_type)){
						string tmp = util_flipspaces(m.submit);
						content = string_f("<audio controls>\n"
							"<source src=\"%s?webstep=%u&image=%s&mod=%s\" type=\"audio/%s\">\n"
							"</audio>"
							,tlmpweb_curpage(),step_image,path.c_str(),tmp.c_str(),tbftype[m.file_type]);
					}else if (file_is_image(m.file_type)){
						content = index_img (step_image,image_width,"",path,m.submit);
					}else if (file_is_video(m.file_type)){
						string tmp = util_flipspaces(m.submit);
						content = string_f(
							"<video width=\"%u\" height=\"%u\" controls>\n"
							"<source src=\"%s?webstep=%u&image=%s&mod=%s\" type=\"video/mp4\">\n"
							"Your browser does not support the video tag.\n"
							"</video>"
							,video_size,video_size
							,tlmpweb_curpage(),step_image,path.c_str(),tmp.c_str());
					}else if (file_is_text(m.file_type)){
						// Large text file
						<call bod_client_readfile_bob>(*glocal.con,w_session.c_str(),path,"",true);
						<f ok>
							if (!success){
								htmlprintf (MSG_U(E_CANTREADFILE,"Can't read file: %s\n"),msg);
							}else{
								string tmp = string((const char*)content.getbuffer(),content.getsize());
								tmp = util_format_shortmsg (tmp.c_str(),5);
								glocal.webtable.setrow("image",glocal.rownum,"\t%s\a",tmp.c_str());
							}
						</f>
						</call>
					}
					string time = string_f("<div id=date0_7>%s</div>",format_time(userinfo.dateformat,m.submit+11).c_str());
					const char *style = line_styles[line_style];
					line_style++;
					if (line_style == 2) line_style = 0;
					if (strcmp(m.from,userinfo.name.c_str())==0){
						glocal.webtable.setrow (style,glocal.rownum,"\t\t%s\t%s"
							,time.c_str(),content.c_str());
					}else{
						string img;
						if (strcmp(m.from,"admin")==0){
							// admin is not in the contact list of everyone, but has a public page
							img = "<img src=/public/admin/project/mini-photo.jpg>";
						}else{
							string dir = string_f("/projects/%s/public",m.from);
							img = index_img(step_image,mini_image_width,dir,"mini-photo.jpg",m.submit);
						}
						glocal.webtable.setrow (style,glocal.rownum,"%s\t%s\t%s\t%s"
							,img.c_str(),m.from,time.c_str(),content.c_str());
					}
					glocal.rownum++;
				}
			}
		</f>
		</call>
	</f>
	</call>
}
</mod>

/*
	Define a form field to edit the access of a group within a list
*/
static void index_field_access (_F_form *c, W_VAR &var)
{
	c->field_list (var,"");
	c->field_list_item ("",MSG_U(I_INHERIT,"inherit"));
	c->field_list_item ("R",MSG_U(I_READONLY,"read-only"));
	c->field_list_item ("W",MSG_U(I_READWRITE,"read-write"));
	c->field_list_end();
}
static void index_field_group (_F_form *c, W_VAR &var, const vector<string> &groups)
{
	c->field_list (var,"");
	c->field_list_item("","");
	for (auto &s:groups) c->field_list_item (s.c_str(),s.c_str());
	c->field_list_end();
}


/*
	Update a group definition in a list
*/
<mod>
static void index_set_group (CONNECT_INFO &con, W_SSTRING &list, const char *group, const char *access, bool &fail)
{
	glocal bool fail = false;
	glocal const char *groupname = group;
	<call bod_client_set_group>(con,w_session.c_str(),list.c_str(),glocal.groupname,access,"");
	<f ok>
		if (!success){
			htmlprintf (MSG_U(E_UPDGROUP,"Failure to update group %s: %s<br>\n"),glocal.groupname,msg);
			glocal.fail = true;
		}
	</f>
	</call>
	if (glocal.fail) fail = true;
}
</mod>
static void index_set_group (CONNECT_INFO &con, W_SSTRING &list, W_SSTRING &group, W_SSTRING &access, vector<string> &groups, bool &fail)
{
	const char *groupname = group.c_str();
	if (groupname[0] != '\0'){
		groups.push_back(groupname);
		index_set_group (con,list,groupname,access.c_str(),fail);
	}
}

static void index_delete_new_from_old(const vector<string> &news, vector<string> &old)
{
	for (auto &n:news){
		auto p = find(old.begin(),old.end(),n);
		if (p != old.end()){
			old.erase(p);
		}
	}
}
static const char *adding = "__add__";
static bool profile_formactive (_F_webtabs &c, W_SSTRING &var)
{
	const char *state = c.getstate();
	if (w_add.isset()){
		c.setstate(adding);
	}else if (var.isset()){
		c.setstate(var.c_str());
	}else if (state[0] != '\0'){
		if (strcmp(state,adding)==0){
			w_add.setinitval("1");
		}else{
			var.setinitval(state);
		}
	}
	return var.isset() || w_add.isset();
}
static bool profile_formactive (_F_webtabs &c)
{
	const char *state = c.getstate();
	if (w_add.isset()){
		c.setstate(adding);
	}else if (state[0] != '\0'){
		if (strcmp(state,adding)==0){
			w_add.setinitval("1");
		}
	}
	return w_add.isset();
}
/*
	Format the path of a mail
*/
static string index_format_mail_fname(const MESSAGE_receive &m)
{
	string fname;
	if (m.role[0] != '\0'){
		fname = string_f ("/msg-projects/%s/%s/%s/%s",m.manager,m.project,m.role,m.uuid);
	}else if (m.manager[0] != '\0'){
		fname = string_f ("/msg-projects/%s/%s/%s",m.manager,m.project,m.uuid);
	}else{
		fname = string_f ("/msgs/%s/inbox/%s",userinfo.name.c_str(),m.uuid);
	}	
	return fname;
}
static void index_script()
{
	// Script to make sure the webtabs tabs use the full height of the screen
	// Then it takes the webtables and grows them too.
	<?
	<script>
		document.onreadystatechange = function () {
			var state = document.readyState;
			if (state == 'interactive') {
				fixsize();
			} else if (state == 'complete') {
			}
		};
		var diff = 0;
		function allDescendants (node,total) {
			//console.log ("Enter " + node.className + " " + node.id);
			if (node.className == "tabs"){
				var bord=(node.offsetHeight-node.clientHeight);
				var style = node.currentStyle || window.getComputedStyle(node);
				var margins = parseInt(style.marginTop,10) + parseInt(style.marginBottom,10);
				var paddings = parseInt(style.paddingTop,10) + parseInt(style.paddingBottom,10);
				total += bord + margins + paddings;
				console.log ("border node.id=" + node.id + " total="+total+" bord="+bord);
			}
			for (var i = 0; i < node.childNodes.length; i++) {
				var child = node.childNodes[i];
				if (child.id != null
					&& (child.id == "tabs"
						|| child.id == "tab_form"
						|| child.id == "webtable-top")){
					total += child.offsetHeight;
					if (child.id == "tab_form") total += 2;	// Bug scrollbar ???
					console.log ("child.id=" + child.id + " total="+total+" height="+child.offsetHeight);
				}else{
					if (child.id != null && child.id == "vframe2h"){
						var bord=(child.offsetWidth-child.clientWidth);
						total += bord;
						console.log ("border child.id=" + child.id + " total="+total+" border="+bord);
					}else if (child.className == "webtable"){
						console.log ("Set webtable "+child.id+" total="+total+" diff="+diff+" oldheight="+child.offsetHeight);
						child.style.height = diff - total;
						break;
					}
					total = allDescendants(child,total);
				}
			}
			return total;
		}
		function fixsize(){
			var t = document.getElementById('head').offsetHeight;
			diff = window.innerHeight-t;
			document.getElementById('body').style.height = diff-1;
			document.getElementById('main').style.height = window.innerHeight-1;
			var tabs = document.getElementsByClassName("tabs");
			for (var i=0; i<tabs.length; i++){
				var node = tabs[i];
				var style = node.currentStyle || window.getComputedStyle(node);
				var margins = parseInt(style.marginTop,10);
				margins += parseInt(style.marginBottom,10);
				node.style.height = diff-2-margins;
			}
			console.log ("tabs.length=" + tabs.length);
			var i;
			for (i=0; i<tabs.length; i++){
				allDescendants (tabs[i],0);
			}
			var tables = document.getElementsByClassName('webtable');
			console.log ("ready " + document.readyState);
			for (i = 0; i < tables.length; i++) {
				var table = tables[i];
				console.log (table.id+" "+table.offsetHeight+" "+table.offsetWidth);
			}
		}
	</script>
	?>
}

<mod>
extern "C" void webmain_real()
{
	glocal bool account_confirmed = false;
	glocal CONNECT_INFO con;
	glocal CONNECT_INFO con_sess;
	glocal.con.port = "/dev/bod.sock";
	glocal.con_sess.port = "/dev/sessiond.sock";
	glocal vector<DOCUMENT_POINTER> docpointers;
	glocal.con.secret = util_readsecret();
	glocal.con_sess.secret = glocal.con.secret;
	for (unsigned i=0; i<SECTION_NBSECTIONS; i++) glocal.docpointers.push_back(DOCUMENT_POINTER());
	if (tlmpweb_isrobot()) w_robot = 1;
	<call loadfile>("/etc/bolixonode.conf",true);
	<f oneline>
		if (strncmp(line,"node=",5)==0){
			const char *pt = line+5;
			if (strncasecmp(pt,"http://",7)==0){
				pt+=7;
			}else if (strncasecmp(pt,"https://",8)==0){
				pt+=8;
			}
			util_setnodename(pt);
		}
		if (strncmp(line,"dirserver=",10)==0) util_setdirserver(line+10);
		if (strncmp(line,"org=",4)==0) org = line+4;
		if (strcmp(line,"private_site")==0) private_site = true;
		return 0;
	</f>
	</call>
	// debug
	is_mobile = tlmpweb_ismobile();
	if (0){
		<call savefile>("/tmp/environ.log",false);
		<f dowrite>
			extern char **environ;
			char **ptenv = environ;
			while (*ptenv != NULL){
				fprintf (fout,"%s\n",*ptenv);
				ptenv++;
			}
			return 0;
		</f>
		</call>
	}
	{
		<call savefile>("/tmp/agent.log",true);
		<f dowrite>
			string ip = tlmpweb_getip();
			const char *pt = getenv ("HTTP_USER_AGENT");
			if (pt == NULL){
				fprintf (fout,"%s: robot=%u HTTP_USER_AGENT null\n",ip.c_str(),w_robot.getval());
			}else{
				fprintf (fout,"%s: robot=%u HTTP_USER_AGENT %s\n",ip.c_str(),w_robot.getval(),pt);
			}
			return 0;
		</f>
		</call>
	}
	
	const char *ptsession = tlmpweb_getcookie("session");
	if (ptsession == NULL){
		<call bod_client_createsession>(glocal.con);
		<f ok>
			w_session = sessionid;
			websession_setcookie("session",sessionid,time(NULL)+48*60*60);
		</f>
		</call>
	}else{
		w_session=ptsession;
		trli_getsessioninfo(glocal.con,glocal.con_sess,glocal.docpointers);
	}
	if (w_session.empty()) return;
	
	<obj WEBCONTEXT wctx>();
	<f savetablegeometry>
		VAR var;
		var.name = "geometry";
		for (auto &v:tb){
			SNAMEVAL val;
			val.sname = "id";
			val.sval = v.id.c_str();
			var.vals.push_back(val);
			val.sname = "height";
			val.sval = string_f("%u",v.height);
			var.vals.push_back(val);
			val.sname = "width";
			val.sval = string_f("%u",v.width);
			var.vals.push_back(val);
		}
		//tlmp_error ("savetablegeometry setvar\n");
		<call bo_sessiond_client_setvar>(glocal.con_sess,w_session.c_str(),var);
		<f ok>
			if (!success) tlmp_error ("Can't set variable geometry: %s\n",msg);
		</f>
		</call>
	</f>
	<f settablecoor>
		/*
			We avoid poluting the session manager with fake request.
			So we make sure the request is associated with a real or possible webtable
			We do the markview at the same time.
		*/
		glocal bool valid = false;
		if (tableid[0] == '/'){
			glocal const char *dir = tableid;
			<call bod_client_listdir>(glocal.con,w_session.c_str(),tableid,"",false,current_row,1);
			<f ok>
				if (files.size()==1){
					glocal.valid = true;
					string fname = string_f("%s/%s",glocal.dir,files[0].name);
					index_markview (glocal.con,fname);
				}
			</f>
			</call>
		}else if (strncmp(tableid,"inbox",5)==0){
			const char *project = tableid+5;
			if (strcmp(project,"INBOX")==0) project = "";
			<call bod_client_list_msgs>(glocal.con,w_session.c_str(),"",project,false,current_row,1);
			<f ok>
				if (messages.size()==1){
					glocal.valid = true;
					string fname = index_format_mail_fname(messages[0]);
					index_markview (glocal.con,fname);
				}
			</f>
			</call>
		}else if (strncmp(tableid,"list:",5)==0){
			const char *tab = tableid+5;
			if (strcmp(tab,"projects")==0
				|| strcmp(tab,"groups")==0
				|| strcmp(tab,"interests")==0
				|| strcmp(tab,"contacts")==0){
				glocal.valid = true;
			}
		}else if (strncmp(tableid,"tab:",4)==0){
			const char *tab = tableid+4;
			if (strcmp(tab,"projects")==0
				|| strcmp(tab,"mails")==0
				|| strcmp(tab,"talk")==0){
				glocal.valid = true;
			}
		}else if (strncmp(tableid,"talkpublic",4)==0){
			// Preview mode
			glocal.valid = true;
		}else if (strncmp(tableid,"talk",4)==0){
			vector<string> tb;
			int n = str_splitline (tableid+4,':',tb);
			if (n == 2){
				<call bod_client_list_talk>(glocal.con,w_session.c_str(),"",tb[1],tb[0],current_row,1);
				<f ok>
					if (messages.size()==1){
						glocal.valid = true;
					}
				</f>
				</call>
			}
		}
		if (glocal.valid){
			unsigned &cur = currents[tableid];
			unsigned &off = offsets[tableid];
			//tlmp_error ("settablecoor tableid=%s set=%d cur=%u current_row=%u\n",tableid,current_row_set,cur,current_row);
			if (current_row_set && cur != current_row){
				cur = current_row;
				web_updatecurrents(glocal.con_sess);
			}
			if (offset_set && off != offset){
				off = offset;
				web_updateoffsets(glocal.con_sess);
			}
		}else{
			tlmp_error ("settablerow unknown tableid %s %d\n",tableid,current_row);
		}
	</f>
	<f recordform>
		bool update = false;
		if (forms.size() != currentforms.size()){
			update = true;
		}else{
			// Forms have fixed field definition. So we compare only
			// to see if the same form IDs are in the list
			for (auto &v:forms){
				bool found = false;
				for (auto &c:currentforms){
					if (c.id == v.formid){
						found = true;
					}
				}
				if (!found) update = true;
			}
		}
		if (update){
			VAR var;
			var.name = "currentform";
			for (auto &v:forms){
				SNAMEVAL val;
				val.sname = "id";
				val.sval  = v.formid;
				var.vals.push_back(val);
				for (auto &vv:v.variables){
					val.sname = "var";
					val.sval = vv->getname();
					var.vals.push_back(val);
				}
			}
			//tlmp_error ("recordform setvar\n");
			<call bo_sessiond_client_setvar> (glocal.con_sess,w_session.c_str(),var);
			<f ok>
				if (!success) tlmp_error (MSG_U(E_SAVECURFORM,"Can't save active form state: %s\n"),msg);
			</f>
			</call>
		}
	</f>
	<f restoreform>
		glocal int ret = -1;
		if (userinfo.name.size()==0){
			glocal.ret = 0;
		}else{
			glocal const char *formid = formid;
			<call bod_client_form_readvar>(glocal.con,w_session.c_str(),formid);
			<f ok>
				if (!success){
					tlmp_error (MSG_U(E_RESTOREFORM,"Can't restore active form state %s: %s\n"),glocal.formid,msg);
				}else{
					if (vars.size() > 0){
						glocal.ret = 0;
						for (auto &v:vars){
							tlmpweb_setvar (v.name,v.val);
						}
					}	
				}
			</f>
			</call>
		}
		return glocal.ret;
	</f>
	<f deleteform>
		if (userinfo.name.size() > 0){
			glocal const char *formid = formid;
			<call bod_client_form_deletevar>(glocal.con,w_session.c_str(),formid);
			<f ok>
				if (!success) tlmp_error ("deleteform %s: %s\n",glocal.formid,msg);
			</f>
			</call>
		}
	</f>
	<f deleteallform>
		<call bod_client_form_deleteall>(glocal.con,w_session.c_str());
		<f ok>
			if (!success) tlmp_error ("deleteallform: %s\n",msg);
		</f>
		</call>
	</f>
	<f saveform>
		if (currentforms.size() > 0){
			for (auto &form:currentforms){
				FORMVARS f;
				glocal const char *id = form.id.c_str();
				f.id = form.id;
				for (auto &v:form.vars){
					FORMVAR var;
					var.name = v;
					var.val = t_varstr(v.c_str());
					f.vars.push_back(var);
				}
				<call bod_client_form_savevar>(glocal.con,w_session.c_str(),f);
				<f ok>
					if (!success){
						if (internal_error){
							tlmp_error ("internal_error saveform currentform %s\n",glocal.id);
						}else{
							tlmp_error (MSG_U(E_SAVEFORM,"saveform currentform %s: %s\n"),glocal.id,msg);
						}
					}
				</f>
				</call>
			}
		}
	</f>
	<f webtableinit>
		if (strncmp(tableid,"list:",5)==0 || strncmp(tableid,"inbox",5)==0){
			c.settableparms ("border=0");
		}else{
			c.settableparms ("border=0");
		}
		c.setthparms ("align=left bgcolor=lightgray","");
		c.setrowstyle ("sep","bgcolor=ghostwhite valign=top");
		c.setrowstyle ("sep+current","bgcolor=lightblue valign=top");
		c.setrowstyle ("sep1","bgcolor=white valign=top");
		c.setrowstyle ("sep1+current","bgcolor=lightblue valign=top");
		c.setrowstyle ("hline","bgcolor=gray valign=top");
		c.setrowstyle ("white","bgcolor=white");
		c.setrowstyle ("white+current","bgcolor=lightblue");
		c.setrowstyle ("whitebold","bgcolor=white style='font-weight:bold;'");
		c.setrowstyle ("whitebold+current","bgcolor=lightblue style='font-weight:bold;'");
		//c.setrowstyle ("whitebold","bgcolor=white><b>\b</b>");
		//c.setrowstyle ("whitebold+current","bgcolor=lightblue><b>\b</b>");
		c.setrowstyle ("image","bgcolor=white align=center");
	</f>
	<f savetabs>
		// Save the webtabs state to the session manager
		VAR var;
		var.name = "webtabs";
		for (auto &v:tabs){
			{
				SNAMEVAL val;
				val.sname = string_f("%s:0",v.first.c_str());
				val.sval = string_f("%u,%u,%u,%u"
					,v.second.offsets[0]
					,v.second.offsets[1]
					,v.second.offsets[2]
					,v.second.offsets[3]);
				var.vals.push_back(val);
			}
			for (auto &t:v.second.tabs){
				SNAMEVAL val;
				val.sname = string_f("%s:%c:%s",v.first.c_str(),t.type+'1',t.tab.c_str());
				val.sval = string_f("f=%u,s=%s,t=%s,l=%d",t.selorder,t.state.c_str()
					,t.title.c_str(),t.locked);
				var.vals.push_back(val);
			}
		}
		//tlmp_error ("savetabs setvar\n");
		<call bo_sessiond_client_setvar>(glocal.con_sess,w_session.c_str(),var);
		<f ok>
			if (!success) htmlprintf ("Can't set variable webtabs: %s\n",msg);
		</f>
		</call>
	</f>
	</obj>
	<call websteps>();
	<f setstep>
		if (tlmpweb_isrobot() || w_robot==1){
			step = step_doc;
		}else if (w_session.empty() && step > 2){
			step = 1;
		}else if (userinfo.name.empty() && step != 2 && step != 3 && step != 10 && step != 12){
			step = 1;
		}
	</f>
	<f end>
		/- </div>
		/- </div>
		index_script();
		{
			// Save the position in the document
			bool one_changed = false;
			for (auto &d:glocal.docpointers){
				if (d.ischanged()){
					one_changed = true;
				}
			}
			if (one_changed){
				VAR var;
				var.name = "document";
				for (auto &d:glocal.docpointers){
					unsigned nos = 1;
					for (auto s:d.tb){
						SNAMEVAL val;
						val.sname = string_f("s%u",nos++);
						val.sval = string_f("%u",s);
						var.vals.push_back(val);
					}
				}
				//tlmp_error ("document setvar\n");
				<call bo_sessiond_client_setvar>(glocal.con_sess,w_session.c_str(),var);
				<f ok>
					if (!success) htmlprintf ("Can't set variable document: %s\n",msg);
				</f>
				</call>
			}
		}
	</f>
	<f step1>
		bolixo_title ("",this);
		if (userinfo.name.size() == 0){
			// Anonymous, present public news ?
			// /- So far no public content
			if (!is_mobile){
				DIV d; d.w(50).marginauto().vmargins(30,0).vpaddings(10,10).paddings(10,10).border(1,"black").borderradius(5).bg("white").print();
				htmlout (MSG_R(I_BOLIXO));
				/-<p>
				htmlprintf ("<a href=%s?webstep=12>%s</a>\n",tlmpweb_curpage(),MSG_R(I_COMPLETEDOC));
			}
		}else{
			DIV d("tabs");
			if (is_mobile){
				d.w(100).print();
			}else{
				unsigned w = tlmpweb_screenwidth();
				unsigned dw = 50;
				if (w > 0){
					unsigned pixels = dw/100.0*1920;	// dw% of an HD screen
					dw = pixels*100/w;
					if (dw > 90) dw = 90;
				} 
				d.w(dw).textalign("center").marginauto().border(1,"black").borderradius(5).vmargins(5,5).paddings(5,5).print();
			}
			string table = string("talk")+"public";
			<call webtable>(ID_FOLLOW,table,"100%",currents[table],offsets[table],5);
			<f click>
				<call bod_client_interest_check>(glocal.con,w_session.c_str(),"",noline,1);
				<f ok>
					if (messages.size()!=1){
						htmlprintf ("Internal error: %s\n",msg);
					}else{
						auto &m = messages[0];
						index_popup (glocal.con,step_public,m.content,m.file_type,m.submit
							,string_f("/%s/msg/%s",m.from,m.uuid));
					}
				</f>
				</call>
			</f>
			<f load>
				sethead  (MSG_R(H_TALK));
				glocal unsigned rownum = nbskip;
				<call bod_client_interest_check>(glocal.con,w_session.c_str(),"",nbskip,nblines);
				<f ok>
					// success:b msg messages:U{SHORTMSG}v
					static const char *func = "Popup";
					string day;
					static const char *line_styles[]={"sep","sep1"};
					unsigned line_style = 0;
					unsigned image_width = 200;
					unsigned mini_image_width = 30;
					unsigned video_size = 200;
					if (is_mobile){
						image_width = 300;
						mini_image_width = 60;
						video_size = 300;
					}
					for (auto &m:messages){
						string now = string (m.submit,10);
						if (now != day){
							day = now;
							glocal.webtable.setclickopt (true,"","");
							glocal.webtable.setrow("hline",-1,"<div id=date0_7b>%s</div>\a\a\a"
								,format_date(userinfo.dateformat,day).c_str());
							line_style=0;
						}
						const char *style = line_styles[line_style];
						line_style++;
						if (line_style == 2) line_style = 0;
						if (file_is_sound(m.file_type)){
							glocal.webtable.setclickopt (true,func,"400,100");
						}else if (file_is_video(m.file_type)){
							glocal.webtable.setclickopt (true,func,"800,800");
						}else if (file_is_image(m.file_type)){
							glocal.webtable.setclickopt (true,func,"800,800");
						}else{
							glocal.webtable.setclickopt (true,func,"800,300");
						}
						string time = string_f("<div id=date0_7>%s</div>",format_time(userinfo.dateformat,m.submit+11).c_str());
						string img;
						const char *pt = strchr(m.from,'@');
						if (pt!=NULL){
							string user(m.from,pt-m.from);
							img = string_f("<img width=%u src=https://%s/public/%s/project/mini-photo.jpg>\n"
								,mini_image_width,pt+1,user.c_str());
						}else{
							img = index_img(step_public,mini_image_width,m.from,"project/mini-photo.jpg",m.submit);
						}
						string path = string_f("%s/msg/%s",m.from,m.uuid);
						string content;
						if (m.content[0] != '\0'){
							content = string_f("<div class=smsg>%s</div>",util_format_shortmsg (m.content,5).c_str());
						}else if (file_is_sound(m.file_type)){
							string tmp = util_flipspaces(m.submit);
							content = string_f("<audio controls>\n"
								"<source src=\"%s?webstep=%u&image=%s&mod=%s\" type=\"audio/%s\">\n"
								"</audio>"
								,tlmpweb_curpage(),step_public,path.c_str(),tmp.c_str(),tbftype[m.file_type]);
						}else if (file_is_image(m.file_type)){
							content = index_img (step_public,image_width,"",path,m.submit);
						}else if (file_is_video(m.file_type)){
							string tmp = util_flipspaces(m.submit);
							content = string_f(
								"<video width=\"%u\" height=\"%u\" controls>\n"
								"<source src=\"%s?webstep=%u&image=%s&mod=%s\" type=\"video/mp4\">\n"
								"Your browser does not support the video tag.\n"
								"</video>"
								,video_size,video_size
								,tlmpweb_curpage(),step_public,path.c_str(),tmp.c_str());
						}
						glocal.webtable.setrow (style,glocal.rownum,"%s\t%s\t%s\t%s",img.c_str(),m.from
							,time.c_str(),content.c_str());
						glocal.rownum++;
					}
				</f>
				</call>
			</f>
			</call>
		}
	</f>
	<f step2> // Login
		<call form>("login");
		<f top>
			bolixo_title (MSG_U(T_LOGIN,"Login"),&glocal.websteps);
			/- <p>
			DIV d; d.w(is_mobile ? 80 : 50).marginauto().paddings(10,10).vpaddings(10,10).borderradius(5).border(1,"black").print();
			d.donotend();
			if (glocal.account_confirmed){
				<?#I_ACCTCONFIRM Welcome
			 	<p>
				The account is now confirmed, you can log in
				?>
			}else{
				/- <center><font size=+2>
				htmlprintf (MSG_R(I_NODENAME),util_getnodename());
				/- </font></center><p>
				/-#I_HAVEACCT Already have an account, please login<p>
			}
		</f>
		<f bottom>
			/- </div>
		</f>
		<f setup>
			/- <table border=0 align=center width=100%>
			/- <tr><td>
			/-#I_EMAIL Enter your email
			/- <td style=width:80%>
			field_string (w_email,"style=width:100%");
			/- <tr><td>
			/-#I_PASSWORD Password
			/- <td style=width:80%>
			field_password (w_password,"");
			/- <tr><td>
			button_submit (MSG_U(B_LOGIN,"Login"));
			/- </table>
		</f>
		<f validate>
			bool ret = false;
			if (w_email.is_filled()){
				if (w_password.is_empty()){
					/-#I_PASSWDREQ <font color=red>You must supply a password</font>
				}else{
					ret = true;
				}
			}else{
				/-#I_PROVIDEEMAIL <font color=red>Please provide an email</font>
			}
			return ret;
		</f>
		<f process>
			glocal bool fail = false;
			<call bod_client_login>(glocal.con,w_session.c_str(),w_email.c_str(),w_password.c_str());
			<f ok>
				if (success){
					trli_getsessioninfo(glocal.con,glocal.con_sess,glocal.docpointers);
					glocal.websteps.gotostep(1);
				}else{
					/-#I_LOGINFAILED <font color=red>Login failed, invalid email or password</font>
					glocal.fail = true;
				}
			</f>
			</call>
			fail = glocal.fail;
		</f>
		</call>
	</f>
	<f step3> // Account creation
		if (private_site) return;
		glocal bool account_created = false;
		<call form>("createaccount");
		<f top>
			bolixo_title (MSG_U(T_CREATEACC,"Account creation"),&glocal.websteps);
			DIV d; d.border(1,"black").borderradius(5).paddings(5,5).vpaddings(5,5).marginauto().vmargins(30,30).w(is_mobile ? 80 : 50).print();
			/- <center><font size=+2>
			htmlprintf (MSG_R(I_NODENAME),util_getnodename());
			/- </font></center><p>
			<?#I_NOACCOUNT No account ? Please create one.
			<p>
			Your email will only be used for the following reasons.
			<br>
			<ul>
			<li>Login.
			<li>Account confirmation.
			<li>Account modification confirmation.
			</ul>
			The only information shown on the web site is the nickname. Your email won't appear on the site.
			<p>
			Cookies are used on this site to preserve the states of your session. The cookie allocated to your
			session is deleted at logout time. Cookies have no other uses and are not shared.
			<p>
			See the
			?>
			const char *lang = tlmpweb_getlang();
			if (strcmp(lang,"fr")==0){
				printhref_raw ("/conditions-d-utilisation.html",MSG_U(I_TERMSOFUSE,"terms of use"),false);
			}else{
				printhref_raw ("/terms-of-use.html",MSG_R(I_TERMSOFUSE),false);
			}
			/-#I_MOREDETAILS &nbsp;for more details
		</f>
		<f setup>
			/- <table border=0 align=center>
			/-#I_NICKNAME <tr><td>Select a nickname<td>
			field_string (new_nickname,"");
			/-#I_ENTERMAIL <tr><td>Enter your email<td>
			field_string (new_email,"");
			/-#I_ENTERPWD <tr><td>Password<td>
			field_password (new_password1,"");
			/-#I_CONFIRMPWD <tr><td>Confirm password<td>
			field_password (new_password2,"");
			/- <tr><td>
			button_submit (MSG_U(B_ACCACCOUNT,"Add account"));
			/- </table>
		</f>
		<f validate>
			bool ret = true;
			if (new_nickname.is_empty()){
				/-#E_NEEDNICKMAME <font color=red>Please provide a nickname</font>
				ret = false;
 			}else if (new_email.is_empty()){
				/-#E_NEEDEMAIL <font color=red>Please provide an email</font>
				ret = false;
			}else if (new_password1.is_empty()){
				/-#E_NEEDPWD <font color=red>Please enter a password</font>
				ret = false;
			}else if (strcmp(new_password1.c_str(),new_password2.c_str())!=0){
				/-#E_PWDMISMATCH <font color=red>Passwords do not match</font>
				ret = false;
			}
			return ret;
		</f>
		<f process>
			glocal bool fail = false;
			<call bod_client_adduser>(glocal.con,w_session.c_str(),new_nickname.c_str(),new_email.c_str(),new_password1.c_str(),tlmpweb_getlang());
			<f ok>
				if (confirmid[0] == '\0'){
					glocal.fail = true;
					DIV d; d.w(50).marginauto().print();
					/-#E_CREATACCT <font color=red>Account creation failure </font>
					htmlout (msg);
					/- <p>
				}else{
					glocal.account_created = true;
				}
			</f>
			</call>
			fail = glocal.fail;
		</f>
		</call>
		if (glocal.account_created){
			bolixo_title (MSG_R(T_CREATEACC),&glocal.websteps);
			DIV d; d.marginauto().w(50).vmargins(20,5).vpaddings(5,5).paddings(5,5).border(1,"black").borderradius(5).print();
			<?#I_ACCTCREATED
			The account has been created
			<p>
			A confirmation email has been sent.
			<p>
			Once you received the email click on the link.
			This will complete the account creation process
			?>
		}

	</f>
	<f step4> // Logout
		tlmpweb_deleteallform();
		<call bod_client_logout>(glocal.con,w_session.c_str());
		<f ok>
			userinfo.reset();	//trli_getsessioninfo(glocal.con,glocal.con_sess);
			bolixo_title ("",&glocal.websteps);
			DIV d; d.textalign("center").marginauto().vmargins(50,50).w(50).print();
			/-#I_HOPESEEYOU Hope to see you again
		</f>
		</call>
	</f>
	<f step5> // Send a file
		util_sendfile (glocal.con,w_session.c_str(),w_image.c_str());
		noend();
	</f>	
	<f step6> // Send a file from a user public directory
		util_sendpublicfile (glocal.con,w_image.c_str());
		noend();
	</f>
	<f step7> // TAB Projects
		//HTMLDEBUG d1("t1");
		//HTMLDEBUG d2("t2");
		bolixo_title (MSG_R(M_PROJECTS),this);
		static unsigned size[5]={15,35,50,0,0};
		<call webtabs>(MSG_R(M_PROJECTS),tabs,size);
		<f documents>
			sethelp();
			// List projects
			static const char *id = "tab:projects";
			<call webtable>(id,"100%",currents[id]);
			<f load>
				sethead (MSG_U(H_PROJECTS,"Owner\tProject"));
				<call bod_client_list_inboxes>(glocal.con,w_session.c_str(),"",false);
				<f ok>
					unsigned rownum=0;
					for (auto &inb:inboxes){
						string id = string_f("%s/%s",inb.manager,inb.project);
						const char *style = "white";
						if (glocal.webtabs.selected(id)) glocal.webtable.setcurrent(rownum);
						string add = string_f("webtab_add=1:%s/%s",inb.manager,inb.project);
						glocal.webtable.setclickopt (true,"",add);
						glocal.webtable.setrow (style,rownum,"%s\t%s",inb.manager,inb.project);
						rownum++;
					}
				</f>
				</call>
			</f>
			</call>
		</f>
		<f docmain>
			glocal const char *id = id;
			glocal string path = string_f ("/projects/%s",id);
			glocal bool is_public = false;
			glocal bool is_public_sub = false;
			const char *pt = strchr(id,'/');
			if (pt != NULL){
				// is_public is true for the public project
				// and for sub-directories (direct child) of the public project
				if (strcmp(pt,"/public")==0){
					glocal.is_public = true;
				}else if (strncmp(pt,"/public/",8)==0 && strchr(pt+8,'/') == NULL){
					glocal.is_public = true;
					glocal.is_public_sub = true;
				}
			}
			{
			DIV f; f.id(TAB_FORM).print();
			<call form>(formid);
			<f top>
				/- <table border=0 width=100%>
			</f>
			<f bottom>
				/- </table>
			</f>
			<f setup>
				/- <tr><td>
				/-#I_NEW_FOLDER New folder
				/- <td colspan=2>
				field_string (w_folder,"style=width:100%");
				/- <tr><td colspan=3>
				url_self (string_f("webtab_add=2:%s%c%ld~%s",glocal.id,WEBTAB_MARK,time(NULL),MSG_U(I_NEWDOC,"New_document"))
					,MSG_U(I_CREATENEWDOC,"Create a new document"));
				/- <tr><td>
				field_file (w_upload);
				/- <td align=right>
				button_submit();
			</f>
			<f validate>
				return true;
			</f>
			<f process>
				glocal bool fail = false;
				if (strcmp(w_folder.c_str(),"")!=0){
					string filepath = string_f("%s/%s",glocal.path.c_str(),w_folder.c_str());
					<call bod_client_mkdir>(glocal.con,w_session.c_str(),filepath);
					<f ok>
						if (!success){
							glocal.fail = true;
							htmlprintf (MSG_U(E_CREATEFOLDER,"Can't create folder: %s<br>\n"),msg);
						}else{
							w_folder.setempty();
						}
					</f>
					</call>
				}
				if (strcmp(w_upload.c_str(),"")!=0){
					const char *tempname = tlmpweb_getfilename(w_upload);
					string filepath = string_f("%s/%s",glocal.path.c_str(),w_upload.c_str());
					<call sendfile>(filepath,tempname,glocal.fail);
					<f start>
						<call bod_client_addfile_bob>(glocal.con,w_session.c_str(),filepath,content,more);
						<f ok>
							glocal.sendfile.sethandle(handle);
							glocal.sendfile.setresult(success,msg);
						</f>
						</call>
					</f>
					<f rest>
						<call bod_client_appendfile>(glocal.con,w_session.c_str(),handle,content,more);
						<f ok>
							glocal.sendfile.setresult(success,msg);
						</f>
						</call>
					</f>
					</call>
				}
				keepediting = true;
				fail = glocal.fail;
			</f>
			</call>
			}
			<call webtable>(ID_PROJECT,glocal.path,"100%",currents[glocal.path],offsets[glocal.path],5);
			<f click>
				glocal unsigned dropmenu = dropmenu;
				if (dropmenu == MENU_HELPPREVIEW){
					glocal.webtabs.addtab("2:helppreview",MSG_U(I_HELPPREVIEW,"Preview"));
				}else if (dropmenu == MENU_UNDELETE){
					<call bod_client_undelete> (glocal.con,w_session.c_str(),glocal.path);
					<f ok>
						if (!success) htmlprintf (MSG_U(E_CANTUNDELETEENTRY,"Can't undelete: %s<br>\n"),msg);
					</f>
					</call>
				}else if (dropmenu == MENU_PASTE){
					index_paste(glocal.con,glocal.path);
				}else if (dropmenu == MENU_PREVIEW && glocal.is_public && noline == (unsigned)-1){
					glocal.webtabs.addtab(string_f("2:preview-%s",glocal.id),glocal.id);
				}else{
					if (dropmenu == 0) tlmpweb_flushheader();
					<call bod_client_listdir>(glocal.con,w_session.c_str(),glocal.path,"",false,noline,1);
					<f ok>
						if (files.size()!=1){
							htmlprintf (MSG_U(E_INTERNAL,"Internal error: %s\n"),msg);
						}else{
							auto &f = files[0];
							glocal FILE_TYPE file_type = f.file_type;
							glocal string fname = string_f("%s/%s",glocal.path.c_str(),f.name);
							if (glocal.dropmenu == MENU_DELETE){
								glocal bool ok = false;
								if (f.type == ENTRY_FILE){
									<call bod_client_delfile> (glocal.con,w_session.c_str(),glocal.fname);
									<f ok>
										if (!success) htmlprintf (MSG_U(E_CANTDELETEENTRY,"Can't delete: %s<br>\n"),msg);
										glocal.ok = success;
									</f>
									</call>
								}else{
									<call bod_client_rmdir> (glocal.con,w_session.c_str(),glocal.fname);
									<f ok>
										if (!success) htmlprintf (MSG_U(E_CANTDELETEDIR,"Can't delete folder: %s<br>\n"),msg);
										glocal.ok = success;
									</f>
									</call>
								}
								if (glocal.ok) index_setcopyitem(glocal.con_sess,glocal.fname,f.eventdate,f.name);
							}else if (glocal.dropmenu == MENU_COPY){
								index_setcopyitem(glocal.con_sess,glocal.fname,f.eventdate,f.name);
							}else if (glocal.dropmenu == MENU_RENAME){
								glocal const char *oldname = f.name;
								<call form>("rename");
								<f setup>
									/- <table border=0>
									/- <tr><td>
									/-#F_OLDNAME Entry current name
									/- <td>
									htmlout(glocal.oldname);
									/- <tr><td>
									/-#F_NEWNAME New name
									/- <td>
									field_string (w_name,"");
									/- </table>
								</f>
								<f validate>
									return true;
								</f>
								<f process>
									glocal bool fail = false;
									string newname = string_f("%s/%s",glocal.path.c_str(),w_name.c_str());
									<call bod_client_rename>(glocal.con,w_session.c_str(),glocal.fname,newname.c_str());
									<f ok>
										if (!success){
											glocal.fail = true;
											htmlprintf (MSG_U(E_RENAME,"Rename failed: %s<br>\n"),msg);
										}
									</f>
									</call>
									fail = glocal.fail;
								</f>
								</call>
							}else if (glocal.dropmenu == MENU_DOWNLOAD){
								tlmpweb_header ("Content-Disposition"," attachment; filename=%s",f.name);
								util_sendfile (glocal.con,w_session.c_str(),glocal.fname);
							}else if (glocal.dropmenu == MENU_PREVIEW){
								if (glocal.is_public && f.type == ENTRY_DIR){
									string tmp = string_f("%s/%s",glocal.id,f.name);
									glocal.webtabs.addtab(string_f("2:preview-%s",tmp.c_str()),tmp);
								}
							}else if (glocal.dropmenu != 0){
								if (file_is_text(f.file_type)){
									if (f.islarge){
										util_sendfile (glocal.con,w_session.c_str(),glocal.fname);
									}else{
										<call bod_client_readfile>(glocal.con,w_session.c_str(),glocal.fname,"");
										<f ok>
											if (!success){
												index_popup (glocal.con,msg,glocal.file_type,info.modified,glocal.fname);
											}else{
												index_popup (glocal.con,content,glocal.file_type,info.modified,glocal.fname);
											}
										</f>
										</call>
									}
								}
							}else{
								index_popup (glocal.con,"",f.file_type,f.modified,glocal.fname);
							}
						}
					</f>
					</call>
				}
			</f>
			<f load>
				glocal unsigned rownum = nbskip;
				// Defines all posible options for dropdown
				adddrop_opt (MENU_COPY,MSG_U(M_COPY,"Copy"));
				index_setpastemenu (this,glocal.path);
				adddrop_opt (MENU_DELETE,MSG_U(M_DELETE,"Delete"));
				adddrop_opt (MENU_UNDELETE,MSG_U(M_UNDELETE,"Undelete"));
				adddrop_opt (MENU_RENAME,MSG_U(M_RENAME,"Rename"));
				adddrop_opt (MENU_DOWNLOAD,MSG_U(M_DOWNLOAD,"Download"));
				adddrop_opt (MENU_PREVIEW,MSG_U(M_PREVIEWPUB,"Public preview"));
				adddrop_opt (MENU_HELPPREVIEW,MSG_U(M_HELPPREVIEW,"Preview help"));
				if (!glocal.is_public) setdrop_hidden (MENU_HELPPREVIEW);
				if (glocal.is_public){
					glocal.webtable.setdrop_default({MENU_PASTE,MENU_PREVIEW,MENU_HELPPREVIEW});
				}else{
					glocal.webtable.setdrop_default({MENU_PASTE});
				}
				sethead (MSG_U(H_FOLDER,"\tName\tModified\tOwner\tSize"));
				<call bod_client_listdir>(glocal.con,w_session.c_str(),glocal.path,"",false,nbskip,nblines);
				<f ok>
					if (!success) htmlprintf (MSG_U(E_READDIR,"Can't read directory %s: %s<br>\n"),glocal.path.c_str(),msg);
					if (!deletes) glocal.webtable.setdrop_disable(MENU_UNDELETE);
					const char *func = "Popup";
					for (auto &f:files){
						string path = string_f ("%s/%s",glocal.id,f.name);
						glocal.webtable.setdrop_hidden (MENU_PREVIEW);
						if (bolixo_isdir(f.type)){
							if (glocal.is_public && !glocal.is_public_sub){
								glocal.webtable.setdrop_visible (MENU_PREVIEW);
							}
							glocal.webtable.setclickopt (true,"",string_f("webtab_add=1:%s",path.c_str()));
						}else if (file_is_image(f.file_type)){
							glocal.webtable.setclickopt (true,"",string_f("webtab_add=2:%s~%s",path.c_str(),f.name));
						}else if (file_is_video(f.file_type)){
							glocal.webtable.setclickopt (true,func,"800,800");
						}else if (file_is_sound(f.file_type)){
							glocal.webtable.setclickopt (true,func,"350,50");
						}else if (file_is_text(f.file_type)){
							glocal.webtable.setclickopt (true,"",string_f("webtab_add=2:%s~%s",path.c_str(),f.name));
						}
						if (glocal.webtabs.selected(path)) glocal.webtable.setcurrent(glocal.rownum);
						//static TRANS_NOTLOAD *tbviewed[]={P_MSG_U(I_NEW,"new"),P_MSG_U(I_BLK,"&nbsp;&nbsp;&nbsp;"),P_MSG_U(I_MOD,"mod")};
						static const char *tbviewed[]={"new.png","seen.png","modified.png"};
						char sizestr[20];
						if (bolixo_isdir(f.type)){
							sizestr[0] = '\0';
						}else{
							snprintf (sizestr,sizeof(sizestr)-1,"%u",f.size);
						}
						glocal.webtable.setrow ("white",glocal.rownum,"<img width=20 src=/%s>\t%s%s\t%s\t%s/%s:%s\t%s"
							,tbviewed[f.viewed]
							,f.name,bolixo_isdir(f.type) ? "/" : ""
							,format_date(userinfo.dateformat,f.modified).c_str()
							,f.owner,f.listname,f.listmode,sizestr);
						glocal.rownum++;
					}
				</f>
				</call>
			</f>
			</call>
		</f>
		<f doctype2>
			glocal const char *filename = id;
			glocal string path = string_f("/projects/%s",glocal.filename);
			glocal bool newdocument = false;
			FILEINFO info;
			if (index_entrytype(glocal.con,glocal.path,info)==ENTRY_DIR){
				glocal.newdocument = true;
				info.file_type = FILE_TEXT;
			}
			if (strcmp(id,"help")==0){
				DIV d("webtable"); d.print();
				index_doc(glocal.docpointers[SECTION_PROJECT],section_project);
			}else if (strcmp(id,"helppreview")==0){
				DIV d("webtable"); d.print();
				index_doc(glocal.docpointers[SECTION_PREVIEW],section_preview);
			}else if (strcmp(id,"helpmain")==0){
				DIV d("webtable"); d.print();
				index_doc(glocal.docpointers[SECTION_NONE],section_none);
			}else if (strncmp(id,"preview-",8)==0){
				glocal const char *base = id+8;
				glocal string groupowner;
				const char *pt = strchr(glocal.base,'/');
				if (pt != NULL) glocal.groupowner = string(glocal.base,pt-glocal.base);;
				DIV dd; dd.id(TAB_FORM).bg("#F1F1F1").paddings(5,5).print();
				htmlprintf (MSG_U(I_PREVIEW,"Preview of the folder %s"),glocal.base);
				/- <br>
				dd.end();
				DIV d("webtable"); d.print();
				<call public_page>();
				<f list_talk>
					glocal vector<SHORTMSG> *msgs = &msgs;
					glocal int ret = -1;
					<call bod_client_list_talk>(glocal.con,w_session.c_str(),"","public",glocal.groupowner,offset,nb);
					<f ok>
						if (success){
							glocal.ret = 0;
							glocal.msgs->clear();
							for (auto &m:messages) glocal.msgs->push_back(m);
						}
					</f>
					</call>
					return glocal.ret;
				</f>
				<f listdir>
					glocal int ret = -1;
					glocal vector<FILEINFO> *files = &files;
					string fname;
					if (strcmp(path.ptr,"/")==0){
						fname = string_f("/projects/%s",glocal.base);
					}else{
						fname = string_f("/projects/%s%s",glocal.base,path.ptr);
					}
					<call bod_client_listdir>(glocal.con,w_session.c_str(),fname,"",false,offset,nb);
					<f ok>
						if (success){
							glocal.ret = 0;
							glocal.files->clear();
							for (auto &f:files) glocal.files->push_back(f);
						}
					</f>
					</call>
					return glocal.ret;
				</f>
				<f readfile>
					glocal int ret = -1;
					glocal BOB_TYPE *content = &content;
					string fname = string_f("/projects/%s/%s",glocal.base,path.ptr);
					<call bod_client_readfile_bob>(glocal.con,w_session.c_str(),fname,"",true);
					<f ok>
						if (success){
							glocal.ret = 0;
							*glocal.content = content;
						}
					</f>
					</call>
					return glocal.ret;
				</f>
				<f projecturl>
					string ret;
					string tmp = util_flipspaces(modified.ptr);
					if (strcmp(name.ptr,"/photo.jpg")==0 || strcmp(name.ptr,"/mini-photo.jpg")==0){
						// Those tow are located in the public folder directly
						ret = string_f("%s?webstep=%d&image=/projects/%s/public%s&mod=%s"
							,tlmpweb_curpage(),step_image,glocal.groupowner.c_str(),name.ptr,tmp.c_str());
					}else if (is_image){
						const char *slash = name.ptr[0] == '/' ? "" : "/";
						ret = string_f("%s?webstep=%d&image=/projects/%s%s%s&mod=%s"
							,tlmpweb_curpage(),step_image,glocal.base,slash,name.ptr,tmp.c_str());
					}else{
						string hidden;
						form_gethidden(hidden);
						ret = string_f("%s?file=%s&%s",tlmpweb_curpage(),name.ptr,hidden.c_str());
					}
					return ret;
				</f>
				<f msgurl>
					string ret;
					const char *pt = strchr(glocal.base,'/');
					if (pt != NULL){
						string user (glocal.base,pt-glocal.base);
						string tmp = util_flipspaces(modified.ptr);
						ret = string_f("%s?webstep=%d&image=/msgs/%s/short-inbox/public/%s&mod=%s"
							,tlmpweb_curpage(),step_image,user.c_str(),name.ptr,tmp.c_str());
					}
					return ret;
				</f>
				<f process>
					public_display (*this,glocal.con,userinfo.name,true);
				</f>
				<f sendfile>
					string fname = string_f("/projects/%s/%s",glocal.base,name.ptr);
					tlmp_error ("sendfile %s\n",fname.c_str());
					util_sendfile(glocal.con,w_session.c_str(),fname);
				</f>
				</call>
			}else if (file_is_image(info.file_type)){
				DIV d("webtable"); d.print();
				DIV dd; dd.id(TAB_FORM).bg("#F1F1F1").paddings(5,5).print();
				htmlprintf (MSG_R(I_DOCNAME),glocal.filename);
				/- <br>
				dd.end();
				htmlout (index_img(step_image,"max-width:100%; max-height=100%;",glocal.path,info.modified));
			}else if (info.file_type == FILE_TEXT){
				<call form>(formid);
				<f top>
				</f>
				<f bottom>
				</f>
				<f load>
					if (!glocal.newdocument){
						index_loadfile(glocal.con,glocal.path,w_content);
					}
				</f>
				<f setup>
					{
						DIV f; f.id(TAB_FORM).print();
						/- <table width=100% border=0>
						/- <tr><td valign=top align=left>
						if (glocal.newdocument){
							/-#I_NEWDOCNAME New document name&nbsp;
							field_string (w_filename,"size=30");	
						}else{
							htmlprintf (MSG_U(I_DOCNAME,"Document name:&nbsp;<font size=+1>%s</font>"),glocal.filename);
						}
						/- <td valign=top align=right>
						button_submit(MSG_U(B_SAVE,"Save"));
						/- </table>
					}
					field_textarea(w_content,ID_PRJTEXT,-100,"style=\"border:none\"");
				</f>
				<f validate>
					bool ret = true;
					if (glocal.newdocument){
						if (strcmp(w_filename.c_str(),"")==0){
							/- You must provide a file name
							ret = false;
						}else if (index_entrytype(glocal.con,string_f("%s/%s",glocal.path.c_str(),w_filename.c_str()))!=ENTRY_NONE){
							/- Document already exist
							ret = false;
						}
					}
					return ret;
				</f>
				<f process>
					<call sendfile_var>(glocal.path,w_content,fail);	
					<f start>
						if (glocal.newdocument){
							glocal.path = string_f("%s/%s",glocal.path.c_str(),w_filename.c_str());
							<call bod_client_addfile_bob>(glocal.con,w_session.c_str(),glocal.path,content,more);
							<f ok>
								glocal.sendfile_var.setresult(success,msg);
								glocal.sendfile_var.sethandle(handle);
							</f>
							</call>
						}else{
							<call bod_client_modifyfile_bob>(glocal.con,w_session.c_str(),filepath,content,more);
							<f ok>
								glocal.sendfile_var.setresult(success,msg);
								glocal.sendfile_var.sethandle(handle);
							</f>
							</call>
						}
					</f>
					<f rest>
						<call bod_client_appendfile>(glocal.con,w_session.c_str(),handle,content,more);
						<f ok>
							glocal.sendfile_var.setresult(success,msg);
						</f>
						</call>
					</f>
					</call>
					if (!fail){
						if (glocal.newdocument){
							glocal.webtabs.setid (string_f("%s/%s",glocal.filename,w_filename.c_str()));
							glocal.webtabs.settitle (w_filename.c_str());
							glocal.webtabs.redotab();
							resetstate();
							// We have to mark this document as viewed (we just created it)
							index_markview (glocal.con,glocal.path);
						}else{
							keepediting = true;
						}
					}
				</f>
				</call>
			}
		</f>
		</call>
		/- </table>
	</f>
	<f step8> // TAB Mails
		bolixo_title (MSG_U(T_MAILS,"Mails"),this);
		static unsigned size[5]={15,45,40,0,0};
		<call webtabs>("mails",tabs,size);
		<f documents>
			sethelp();
			static const char *id = "tab:mails";
			<call webtable>(id,"100%",currents[id]);
			<f load>
				sethead (MSG_U(H_INBOXES,"Owner\tProject"));
				setclickopt (true,"",string_f("webtab_add=1:INBOX~%s",MSG_R(I_INBOX)));
				if (glocal.webtabs.selected("INBOX")) setcurrent(0);
				setrow ("white",0,"\t%s",MSG_U(I_INBOX,"INBOX"));
				<call bod_client_list_inboxes>(glocal.con,w_session.c_str(),"",true);
				<f ok>
					unsigned rownum=1;
					for (auto s:inboxes){
						string add = string_f("webtab_add=1:%s",s.project);
						//url_self (add.c_str(),"%s",s.role);
						if (glocal.webtabs.selected(s.project)) glocal.webtable.setcurrent(rownum);
						glocal.webtable.setclickopt (true,"",add);
						glocal.webtable.setrow("white",rownum,"%s\t%s",s.manager,s.project);
						rownum++;
					}
				</f>
				</call>
			</f>
			</call>
		</f>
		<f docmain>
			glocal const char *project = id;
			if (strcmp(id,"INBOX")==0) glocal.project = "";
			string inbox = string("inbox") + id;
			<call webtable>(ID_MAIL,inbox,"100%",currents[inbox],offsets[inbox],5);
			<f click>
				// This code is never called
				tlmpweb_flushheader();
				<call bod_client_list_msgs>(glocal.con,w_session.c_str(),"",glocal.project,false,noline,1);
				<f ok>
					if (messages.size()!=1){
						htmlprintf ("Internal error: %s\n",msg);
					}else{
						htmlprintf ("title=%s<p>\n",messages[0].title);
						string path = index_format_mail_fname(messages[0]);
						<call bod_client_readfile>(glocal.con,w_session.c_str(),path,"");
						<f ok>
							const char *pt = content;
							while (*pt != '\0'){
								const char *start = pt;
								while (*pt != '\0' && *pt != '\n') pt++;
								htmlwrite (start,pt-start);
								htmlout ("<br>\n");
								if (*pt == '\n') pt++;
							}
						</f>
						</call>
					}
				</f>
				</call>
			</f>
			<f load>
				glocal unsigned rownum = nbskip;
				sethead (MSG_U(H_MAILS,"From\tManager\tProject\tRole\tSubmit\tTitle"));
				<call bod_client_list_msgs>(glocal.con,w_session.c_str(),"",glocal.project,false,nbskip,nblines);
				<f ok>
					if (!success){
						//htmlprintf ("Error: %d %s<br>",internal_error,msg);
					}else{
						for (auto &m:messages){
							string path = index_format_mail_fname(m);
							glocal.webtable.setclickopt (true,"",string_f("webtab_add=2:%s~%s"
								,path.c_str(),m.from));
							if (glocal.webtabs.selected(path)) glocal.webtable.setcurrent(glocal.rownum);
							const char *style = m.viewed != VIEWED_OK ? "whitebold" : "white";
							glocal.webtable.setrow (style,glocal.rownum,"%s\t%s\t%s\t%s\t%s\t%s"
								,m.from
								,m.manager
								,m.project
								,m.role
								,format_date(userinfo.dateformat,m.submit).c_str()
								,m.title);
							glocal.rownum++;
						}
					}
				</f>
				</call>
			</f>
			</call>
		</f>
		<f doctype2>
			DIV d("webtable"); d.print();
			if (strcmp(id,"help")==0){
				index_doc(glocal.docpointers[SECTION_MAILS],section_mails);
			}else if (strcmp(id,"helpmain")==0){
				index_doc(glocal.docpointers[SECTION_NONE],section_none);
			}else{
				glocal const char *id = id;
				glocal const char *from = title;
				<call bod_client_readfile>(glocal.con,w_session.c_str(),id,"");
				<f ok>
					vector<string> tb;
					int n = str_splitline (glocal.id,'/',tb);
					/- <table border=0>
					if (n >= 5 && strcmp(tb[3].c_str(),"inbox")!=0){
						if (n >= 6){
							htmlprintf ("<tr><td><b>%s</b><td>%s<td>/<td>%s<td>/<td>%s\n",MSG_U(I_PROJECT,"Project"),tb[2].c_str(),tb[3].c_str(),tb[4].c_str());
						}else{
							htmlprintf ("<tr><td><b>%s</b><td>%s<td>/<td>%s\n",MSG_R(I_PROJECT),tb[2].c_str(),tb[3].c_str());
						}
					}
					htmlprintf ("<tr><td><b>%s</b><td colspan=6>%s\n",MSG_U(I_FROM,"From"),glocal.from);
					htmlprintf ("<tr><td><b>%s</b><td colspan=6>%s\n",MSG_U(I_TITLE,"Title"),info.title);
					htmlprintf ("<tr><td><b>%s</b><td colspan=6>%s\n",MSG_U(I_DATE,"Date"),info.modified);
					/- </table>
					/- <p>
					const char *pt = content;
					while (*pt != '\0'){
						const char *start = pt;
						while (*pt != '\0' && *pt != '\n') pt++;
						htmlout (start,pt-start);
						htmlout ("<br>\n");
						if (*pt == '\n') pt++;
					}
				</f>
				</call>
			}
		</f>
		</call>
		///- </table>
	</f>
	<f step9>	// TAB Talks
		bolixo_title (MSG_U(T_TALKS,"Talks"),this);
		static unsigned size[5]={15,40,45,0,0};
		static unsigned size_mobile[5]={25,60,15,0,0};
		<call webtabs>("talks",tabs,is_mobile ? size_mobile : size);
		<f documents>
			sethelp();
			static const char *id = "tab:talk";
			<call webtable>(id,"100%",currents[id]);
			<f load>
				sethead (MSG_U(H_TALKS,"Owner\tGroup"));
				<call bod_client_list_groups>(glocal.con,w_session.c_str(),"",false);
				<f ok>
					// Make sure the inbox and public inbox (anonymous) appears at the
					// top
					unsigned rownum = 0;
					const char *username = userinfo.name.c_str();
					string id = string_f("%s:inbox",username);
					string add = string_f("webtab_add=1:%s:inbox~%s",username,MSG_U(I_SHORTINBOX,"Inbox"));
					if (glocal.webtabs.selected(id)) glocal.webtable.setcurrent(rownum);
					glocal.webtable.setclickopt (true,"",add);
					glocal.webtable.setrow ("white",rownum,"\t%s",MSG_R(I_SHORTINBOX));
					rownum++;
					for (auto &g:groups){
						if (userinfo.name != g.owner
							|| (strcmp(g.name,"inbox")!=0 && strcmp(g.name,"anonymous")!=0)){
							id = string_f("%s:%s",g.owner,g.name);
							add = string_f("webtab_add=1:%s:%s",g.owner,g.name);
							if (glocal.webtabs.selected(id)) glocal.webtable.setcurrent(rownum);
							glocal.webtable.setclickopt (true,"",add);
							glocal.webtable.setrow ("white",rownum,"%s\t%s",g.owner,g.name);
							rownum++;
						}
					}
					id = string_f("%s:anonymous",username);
					add = string_f("webtab_add=1:%s:anonymous~%s",username,MSG_U(I_ANONINBOX,"Public-inbox"));
					if (glocal.webtabs.selected(id)) glocal.webtable.setcurrent(rownum);
					glocal.webtable.setclickopt (true,"",add);
					glocal.webtable.setrow ("white",rownum,"\t%s",MSG_R(I_ANONINBOX));
				</f>
				</call>
			</f>
			</call>
		</f>
		<f docmain>
			vector<string> tb;
			int n = str_splitline (id,':',tb);
			if (n != 2) return;
			glocal string groupowner = tb[0];
			glocal string groupname = tb[1];
			if (glocal.groupname != "anonymous"){
				glocal bool private_inbox = glocal.groupname == "inbox";
				DIV f; f.id(TAB_FORM).print();
				<call form>(formid);
				<f top>
					/- <table border=0 width=100%>
				</f>
				<f bottom>
					/- </table>
				</f>
				<f setup>
					if (glocal.private_inbox){
						/- <tr><td>
						/-#F_RECIPIENTS Recipients
						/- <td style=width:99%>
						field_string(w_recipients,"style=width:100%");
					}
					/- <tr><td colspan=2>
					field_textarea (w_content,5,-100,"");
					/- <tr><td>
					field_file (w_upload);
					/- <td align=right>
					button_submit (MSG_U(B_SEND,"Send"));
					if (!glocal.private_inbox){
						/- <tr><td>
						/-#F_EXTRARECIPIENTS Extra recipients(opt)
						/- <td style=width:99%>
						field_string(w_recipients,"style=width:100%");
					}
				</f>
				<f validate>
					bool ret = true;
					if (glocal.private_inbox && w_recipients.size()==0){
						/-#E_ONERECIPIENT You must specify at least one recipient
						ret = false;
					}
					return ret;
				</f>
				<f process>
					glocal bool fail = false;
					glocal vector<string> recipients;
					str_splitline(w_recipients.c_str(),' ',glocal.recipients);
					if (w_content.size() > 0){
						BOB_TYPE bob;
						bob.setbuffer (w_content.c_str(),w_content.size(),false);
						static vector<string> empty;
						<call bod_client_sendtalk>(glocal.con,w_session.c_str(),"",glocal.recipients
							,glocal.groupname,glocal.groupowner,bob,false,"","","");
						<f ok>
							if (!success){
								htmlprintf (MSG_U(E_CANTSEND,"Can't send: %s<br>\n"),msg);
								glocal.fail = true;
							}
						</f>
						</call>
					}
					if (strcmp(w_upload.c_str(),"")!=0){
						const char *tempname = tlmpweb_getfilename(w_upload);
						<call sendfile>("",tempname,glocal.fail);
						<f start>
							static vector<string> empty;
							<call bod_client_sendtalk>(glocal.con,w_session.c_str(),"",glocal.recipients,glocal.groupname,glocal.groupowner
								,content,more,"","","");
							<f ok>
								glocal.sendfile.sethandle (handle);
								glocal.sendfile.setresult (success,msg);
							</f>
							</call>
						</f>
						<f rest>
							<call bod_client_appendfile>(glocal.con,w_session.c_str(),handle,content,more);
							<f ok>
								glocal.sendfile.setresult (success,msg);
							</f>
							</call>
						</f>
						</call>
					}
					fail = glocal.fail;
					if (!fail){
						w_recipients.setempty();
						w_content.setempty();
						w_upload.setempty();
					}
					keepediting = true;
				</f>
				</call>
			}
			string table = string("talk")+id;
			index_show_shortmsg (glocal.con,glocal.con_sess,glocal.webtabs,table,glocal.groupname,glocal.groupowner);
		</f>
		<f doctype2>
			FILEINFO info;
			index_entrytype(glocal.con,id,info);
			if (strcmp(id,"help")==0){
				DIV d("webtable"); d.print();
				index_doc(glocal.docpointers[SECTION_TALK],section_talk);
			}else if (strcmp(id,"helpmain")==0){
				DIV d("webtable"); d.print();
				index_doc(glocal.docpointers[SECTION_NONE],section_none);
			}else if (file_is_image(info.file_type)){
				DIV d("webtable"); d.print();
				string img = index_img(step_image,"max-width:100%; max-height:100%;",id,info.modified);
				/- <br>
				htmlout (img);
			}else if (file_is_text(info.file_type)){
				DIV d("",TAB_FORM); d.print();
				/- <table border=0>
				vector<string> tb;
				int n=str_splitline(id,'/',tb);
				if (n == 6){	
					htmlprintf ("<tr><td><b>%s</b><td>%s<td>%s\n",MSG_U(I_TALKGROUP,"Group")
						,tb[2].c_str(),tb[4].c_str());
				}
				htmlprintf ("<tr><td><b>%s</b><td>%s\n",MSG_U(I_TALKFROM,"From"),info.owner.c_str());
				/- </table>
				d.end();
				DIV dd("webtable","text"); dd.autoscroll().w(100).bordertop(1,"black").print();
				<call bod_client_readfile>(glocal.con,w_session.c_str(),id,"");
				<f ok>
					string tmp = util_format_shortmsg (content);
					htmlout (tmp);
				</f>
				</call>
			}
		</f>
		</call>
	</f>
	<f step10> // Confirm user
		if (w_confirm.is_empty()){
			/-#E_REACHMISS You have reach this web page by mistake. Sorry!
		}else{
			<call bod_client_confirmuser>(glocal.con,w_confirm.c_str());
			<f ok>
				if (success){
					glocal.account_confirmed = true;
					glocal.websteps.gotostep(step_login);
				}else{
					bolixo_title ("",&glocal.websteps);
					htmlprintf (MSG_U(E_CONFIRMFAILED,"Account confirmation failed: %s\n"),msg);
				}
			</f>
			</call>
		}
			
	</f>
	<f step11> // TAB Profile
		bolixo_title (MSG_U(T_PROFILE,"Profile"),this);
		vector<string> t={
			string_f("Account~%s",MSG_U(T_ACCOUNT,"Account")),
			string_f("Interests~%s",MSG_U(T_INTERESTS,"Interests")),
			string_f("Contacts~%s",MSG_U(T_CONTACTS,"Contacts")),
			string_f("Contact-req~%s",MSG_U(T_CONTACT_REQS,"Requests")),
			string_f("Projects~%s",MSG_U(T_PROJECTS,"Projects")),
			string_f("Groups~%s",MSG_U(T_GROUPS,"Groups"))};
		static unsigned size[5]={0,60,40,0,0};
		<call webtabs>("profile",t,tabs,size);
		<f doctype2>
			DIV f("webtable"); f.print();
			if (strcmp(id,"helpgroups")==0){
				index_doc(glocal.docpointers[SECTION_GROUPS],section_groups);
			}else if (strcmp(id,"helpprojects")==0){
				index_doc(glocal.docpointers[SECTION_PROJECTS],section_projects);
			}else if (strcmp(id,"helpcontacts")==0){
				index_doc(glocal.docpointers[SECTION_CONTACTS],section_contacts);
			}else if (strcmp(id,"helpcontact-req")==0){
				index_doc(glocal.docpointers[SECTION_CONTACT_REQ],section_contact_req);
			}else if (strcmp(id,"helpaccount")==0){
				index_doc(glocal.docpointers[SECTION_ACCOUNT],section_account);
			}else if (strcmp(id,"helpinterests")==0){
				index_doc(glocal.docpointers[SECTION_INTERESTS],section_interests);
			}else if (strcmp(id,"helpmain")==0){
				index_doc(glocal.docpointers[SECTION_NONE],section_none);
			}
		</f>
		<f docmain>
			sethelp("helpprojects",MSG_U(I_HELPPROJECTS,"Projects"));
			if (strcmp(id,"Projects")==0){	// CONF projects
				<call vframe2h>(40);
				<f left>
					{
						DIV t; t.id(TAB_FORM).print();
						url_self ("add=1",MSG_U(I_CREATELIST,"Create a new project"));
						/- <br>&nbsp;<br>
					}
					<call webtable>("list:projects","100%",currents["list:projects"]);
					<f load>
						sethead (MSG_U(H_PROF_PROJECTS,"Project\tMembers\tAccess"));
						<call bod_client_list_lists>(glocal.con,w_session.c_str(),"");
						<f ok>
							unsigned rownum=0;
							for (auto &l:lists){
								if (l.name[0] != '#'){
									string add = string_f("list=%s",l.name);
									glocal.webtable.setclickopt (true,"",add);
									glocal.webtable.setrow ("sep",rownum,"%s\t%s\a",l.name,l.description);
									glocal.webtable.setclickopt (false,"","");
									for (unsigned i=0; i<l.groups.size(); i++){
										glocal.webtable.setrow("white",-1,"\t%s\t%s",l.groups[i],l.access[i]);
									}
								}
								rownum++;
							}
							
						</f>
						</call>
					</f>
					</call>
				</f>
				<f right>
					if (profile_formactive (glocal.webtabs,w_list)){
						<call form>(string_f("project:%s",w_add==1 ? "" : w_list.c_str()));
						<f top>
							/- <table border=0><tr><td>&nbsp;&nbsp;&nbsp;<td><table border=0>
							if (w_add != 1) htmlprintf (MSG_U(T_PROJECT,"<tr><td>Project<td><font size=+2>%s</font><p>\n"),w_list.c_str());
						</f>
						<f bottom>
							/- </table></table>
						</f>
						<f load>
							<call bod_client_list_lists>(glocal.con,w_session.c_str(),"");
							<f ok>
								for (auto &l:lists){
									if (strcmp(l.name,w_list.c_str())==0){
										w_desc = l.description;
										for (unsigned i=0; i<l.groups.size(); i++){
											const char *group = l.groups[i];
											string access = toupper(l.access[i]);
											if (i==0){
												w_group1 = group;
												w_access1 = access;
											}else if (i==1){
												w_group2 = group;
												w_access2 = access;
											}else if (i==2){
												w_group3 = group;
												w_access3 = access;
											}else if (i==3){
												w_group4 = group;
												w_access4 = access;
											}
										}
										break;
									}
								}
							</f>
							</call>
						</f>
						<f setup>
							glocal vector<string> groups;
							// PATCH: Group contacts is not returned by list_groups
							// For the public group, it is necessary. Maybe other projects would
							// need access to special group contact...
							if (strcmp(w_list.c_str(),"public")==0) glocal.groups.push_back("contacts");
							<call bod_client_list_groups>(glocal.con,w_session.c_str(),"",true);
							<f ok>
								for (auto &g:groups) glocal.groups.push_back(g.name);
							</f>
							</call>
							if (w_add == 1){
								/-#I_PRJ_PROJECT <tr><td>Project&nbsp;<td>
								field_string (w_list,"size=30");
								field_hidden(w_add);
							}else{
								field_hidden(w_list);
							}
							/-#I_PRJ_DESCRIPTION <tr><td>Description&nbsp;<td>
							field_string (w_desc,"size=60");
							/- <tr><td>&nbsp;
							/-#I_PRJ_MEMBERS <tr><td valign=top>Members<td><table border=0>
							/-#I_PRJ_GROUP <tr><th>Group<th>Access
							/- <tr><td>
							index_field_group (this,w_group1,glocal.groups);
							/- <td>
							index_field_access (this,w_access1);
							/- <tr><td>
							index_field_group (this,w_group2,glocal.groups);
							/- <td>
							index_field_access (this,w_access2);
							/- <tr><td>
							index_field_group (this,w_group3,glocal.groups);
							/- <td>
							index_field_access (this,w_access3);
							/- <tr><td>
							index_field_group (this,w_group4,glocal.groups);
							/- <td>
							index_field_access (this,w_access4);
							/- </table>
							/- <tr><td>
							button_submit();
						</f>
						<f validate>
							bool ret = true;
							if (strcmp(w_desc.c_str(),"a")==0){
								ret = false;
								/- <font color=red>a is not allowed</font>
								/- <br>
							}
							return ret;
						</f>
						<f process>
							glocal bool fail = false;
							if (w_add == 1){
								<call bod_client_create_group_list>(glocal.con,w_session.c_str(),w_list.c_str(),"");
								<f ok>
									if (!success){
										glocal.fail = true;
										htmlprintf ("Can't create list: %s\n",msg);
									}
								</f>
								</call>
							}
							if (!glocal.fail){
								glocal vector<string> oldgroups;
								<call bod_client_list_lists>(glocal.con,w_session.c_str(),"");
								<f ok>
									for (auto &l:lists){
										if (strcmp(l.name,w_list.c_str())==0){
											for (auto g:l.groups) glocal.oldgroups.push_back(g);
											break;
										}
									}
								</f>
								</call>
								<call bod_client_set_list_desc>(glocal.con,w_session.c_str(),w_list.c_str(),w_desc.c_str(),"");
								<f ok>
									if (!success){
										/- error
										glocal.fail = true;
									}
								</f>
								</call>
								vector<string> newgroups;
								index_set_group (glocal.con,w_list,w_group1,w_access1,newgroups,glocal.fail);
								index_set_group (glocal.con,w_list,w_group2,w_access2,newgroups,glocal.fail);
								index_set_group (glocal.con,w_list,w_group3,w_access3,newgroups,glocal.fail);
								index_set_group (glocal.con,w_list,w_group4,w_access4,newgroups,glocal.fail);
								if (!glocal.fail){
									// We have to remove the groups that are gone
									index_delete_new_from_old(newgroups,glocal.oldgroups);
									// what remains in oldgroups have to be deleted (setting access to - does this)
									for (auto &g:glocal.oldgroups) index_set_group (glocal.con,w_list,g.c_str(),"-",glocal.fail);
								}
							}
							fail = glocal.fail;
							if (!fail){
								if (w_add == 0){
									keepediting = true;
									reload();
								}
								w_add = 0;
							}
						</f>
						</call>
					}
				</f>
				</call>
			}else if (strcmp(id,"Groups")==0){	// CONF groups
				sethelp("helpgroups",MSG_U(I_HELPGROUPS,"Groups"));
				<call vframe2h>(40);
				<f left>
					{
						DIV t; t.id(TAB_FORM).print();
						url_self ("add=1",MSG_U(I_CREATEGROUP,"Create a new group"));
						/- <br>&nbsp;<br>
					}
					<call webtable>("list:groups","100%",currents["list:groups"]);
					<f load>
						sethead (MSG_U(H_GROUPS,"Group\tMembers\tAccess\tRole"));
						<call bod_client_list_groups>(glocal.con,w_session.c_str(),"",true);
						<f ok>
							unsigned rownum=0;
							for (auto &g:groups){
								string add = string_f("group=%s",g.name);
								glocal.webtable.setclickopt (true,"",add);
								glocal.webtable.setrow ("sep",rownum,"%s\t%s\a\a",g.name,g.description);
								glocal.webtable.setclickopt (false,"","");
								for (unsigned i=0; i<g.users.size(); i++){
									glocal.webtable.setrow("white",-1,"\t%s\t%s\t%s",g.users[i],g.access[i],g.roles[i]);
								}
								rownum++;
							}
						</f>
						</call>
					</f>
					</call>
				</f>
				<f right>
					if (profile_formactive (glocal.webtabs,w_group)){
						<call form>(string_f("group:%s",w_add==1 ? "" : w_group.c_str()));
						<f top>
							/- <table border=0><tr><td>&nbsp;&nbsp;&nbsp;<td><table border=0>
							if (w_add != 1) htmlprintf ("<tr><td>Group<td><font size=+2>%s</font><p>\n",w_group.c_str());
						</f>
						<f bottom>
							/- </table></table>
						</f>
						<f load>
							<call bod_client_list_groups>(glocal.con,w_session.c_str(),"",true);
							<f ok>
								for (auto &g:groups){
									if (strcmp(g.name,w_group.c_str())==0){
										w_desc = g.description;
										w_content = "";
										for (unsigned i=0; i<g.users.size(); i++){
											w_content.appendf ("%s:%s:%s\n",g.users[i],g.access[i],g.roles[i]);
										}
										break;
									}
								}
							</f>
							</call>
						</f>
						<f setup>
							if (w_add == 1){
								/-#I_GROUP <tr><td>Group&nbsp;<td>
								field_string (w_group,"size=30");
								field_hidden(w_add);
							}else{
								field_hidden(w_group);
							}
							/-#I_DESCRIPTION <tr><td>Description&nbsp;<td>
							field_string (w_desc,"size=60");
							/- <tr><td>&nbsp;
							/-#I_MEMBERS <tr><td valign=top>Members<td>
							field_textarea (w_content,20,60,"");
							/- <tr><td>
							button_submit();
						</f>
						<f validate>
							bool ret = true;
							return ret;
						</f>
						<f process>
							glocal bool fail = false;
							if (w_add == 1){
								<call bod_client_create_group>(glocal.con,w_session.c_str(),w_group.c_str(),"");
								<f ok>
									if (!success){
										glocal.fail = true;
										htmlprintf (MSG_U(E_CANTCREATEGROUP,"Can't create group: %s<br>\n"),msg);
									}
								</f>
								</call>
							}
							if (!glocal.fail){
								glocal vector<string> oldusers;
								<call bod_client_list_groups>(glocal.con,w_session.c_str(),"",true);
								<f ok>
									for (auto &g:groups){
										if (strcmp(g.name,w_group.c_str())==0){
											for (auto u:g.users) glocal.oldusers.push_back(u);
											break;
										}
									}
								</f>
								</call>
								<call bod_client_set_group_desc>(glocal.con,w_session.c_str(),w_group.c_str(),w_desc.c_str(),"");
								<f ok>
									if (!success){
										htmlprintf (MSG_U(E_CANTSETGROUPDESC,"Can't set group description: %s<br>\n"),msg);
										glocal.fail = true;
									}
								</f>
								</call>
								vector<string> newusers,newaccesses,newroles;
								const char *pt = w_content.c_str();
								while (*pt != '\0'){
									string word;
									pt = str_copyword(word,pt);
									vector<string> tb;
									int n = str_splitline(word.c_str(),':',tb);
									if (n > 0){
										while (tb.size() < 3) tb.push_back("");
										newusers.push_back (tb[0]);
										newaccesses.push_back(tb[1]);
										newroles.push_back(tb[2]);
									}
								}
								for (unsigned i=0; !glocal.fail && i<newusers.size(); i++){
									glocal const char *user = newusers[i].c_str();
									<call bod_client_set_member>(glocal.con,w_session.c_str(),w_group.c_str()
										,glocal.user,newaccesses[i].c_str(),newroles[i].c_str(),"");
									<f ok>
										if (!success){
											glocal.fail = true;
											htmlprintf (MSG_U(E_CANTSETMEMBER,"Can't set member %s: %s\n"),glocal.user,msg);
										}
									</f>
									</call>
								}
								if (!glocal.fail){
									// We have to remove the groups that are gone
									index_delete_new_from_old(newusers,glocal.oldusers);
									// what remains in oldusers have to be deleted (setting access to - does this)
									for (auto &g:glocal.oldusers){
										glocal const char *user = g.c_str();
										<call bod_client_set_member>(glocal.con,w_session.c_str(),w_group.c_str()
											,glocal.user,"-","","");
										<f ok>
											if (!success){
												glocal.fail = true;
												htmlprintf (MSG_U(E_CANTDELMEMBER,"Can't delete member %s: %s\n"),glocal.user,msg);
											}
										</f>
										</call>
									}
								}
							}
							fail = glocal.fail;
							if (!fail){
								if (w_add == 0){
									keepediting = true;
									reload();
								}
								w_add = 0;
							}
						</f>
						</call>
					}
				</f>
				</call>
			}else if (strcmp(id,"Contacts")==0 || strcmp(id,"Contact-req")==0){	// CONF contacts
				glocal bool to_me = strcmp(id,"Contacts")==0;
				if (glocal.to_me){
					sethelp("helpcontacts",MSG_U(I_HELPCONTACTS,"Contacts"));
				}else{
					sethelp("helpcontact-req",MSG_U(I_HELPCONTACT_REQ,"Requests"));
				}
				<call vframe2h>(40);
				<f left>
					if (!glocal.to_me){
						DIV f; f.id(TAB_FORM).print();
						url_self ("add=1",MSG_U(I_NEWCONTACT,"Send a contact request"));
						/- <br>&nbsp;<br>
					}
					static const string id = "list:contacts";
					<call webtable>(ID_CONTACT,id,"100%",currents[id],offsets[id],10);
					<f load>
						sethead (MSG_U(H_CONTACTS,"User\tDate\tStatus"));
						<call bod_client_contact_list>(glocal.con,w_session.c_str(),"",glocal.to_me,nbskip,nblines);
						<f ok>
							static const char *tbstatus[]={MSG_U(I_WAITING,"waiting"),MSG_U(I_ACCEPTED,"accepted"),MSG_U(I_REJECTED,"rejected")};
							unsigned rownum = 0;
							for (auto &c:contacts){
								glocal.webtable.setclickopt (true,"",string_f("user=%u:%s",rownum,c.user));
								glocal.webtable.setrow("white",rownum,"%s\t%s\t%s",c.user
									,format_date(userinfo.dateformat,c.reqdate).c_str(),tbstatus[c.status]);
								rownum++;
							}
						</f>
						</call>
					</f>
					</call>
				</f>
				<f right>
					if (profile_formactive (glocal.webtabs,w_user)){
						if (w_add.isset()){
							glocal bool done = false;
							<call form>("contact");
							<f top>
								/- <table border=0><tr><td>&nbsp;&nbsp;&nbsp;<td><table border=0>
								/- <table border=0>
								/- <tr><td><td>
								/-#I_SENDCONTACT <h2>Send a contact request</h2>
							</f>
							<f bottom>
								/- </table></table>
							</f>
							<f setup>
								field_hidden (w_add);
								/-#I_TOCONTACT <tr><td>Person to contact<td>
								field_string (w_user,"size=30");
								/-#I_MESSAGE <tr><td valign=top>Message<td>
								field_textarea (w_content,10,60,"");
								/- <tr><td>
								button_submit();
							</f>
							<f validate>
								return true;
							</f>
							<f process>
								glocal bool fail = false;
								<call bod_client_contact_request>(glocal.con,w_session.c_str(),"",w_user.c_str(),w_content.c_str());
								<f ok>
									if (!success){
										glocal.fail = true;
										htmlprintf (MSG_U(E_CONTACTFAIL,"Contact request failed: %s<br>\n"),msg);
									}else{
										glocal.done = true;
									}
								</f>
								</call>
								fail = glocal.fail;
							</f>
							</call>
							if (glocal.done){
								/-#I_CONTACTSENT Contact request sent!
							}
						}else if (glocal.to_me && w_user.isset()){
							glocal bool done = false;
							glocal CONTACT_STATUS status = CONTACT_WAITING;
							glocal string user;
							const char *pt = strchr(w_user.c_str(),':');
							if (pt != NULL) glocal.user = pt+1;
							<call form>(string_f("managecontact:%s",w_user.c_str()));
							<f top>
								/- <table border=0><tr><td>&nbsp;&nbsp;&nbsp;<td><table border=0>
								/- <tr><td><td>
								/-#I_MANAGECONTACT <h2>Manage a contact</h2>
							</f>
							<f bottom>
								/- </table></table>
							</f>
							<f load>
								unsigned rownum = atoi(w_user.c_str());
								<call bod_client_contact_list>(glocal.con,w_session.c_str(),"",glocal.to_me,rownum,1);
								<f ok>
									if (contacts.size() == 1){
										auto &c = contacts[0];
										w_content = c.message;
									}
								</f>
								</call>
							</f>
							<f setup>
								field_hidden(w_user);
								/- <tr><td>
								/-#I_REQUESTFROM Request from
								/- <td>
								htmlout (glocal.user);
								htmlout (MSG_R(I_MESSAGE));
								field_textarea(w_content,5,55,"readonly");
								/- <tr><td>
								/-#I_ACCEPTREQ Accept request
								/- <td>
								field_radio(w_accept,"accept",true,"");
								/- <tr><td>
								/-#I_REFUSEREQ Refuse request
								/- <td>
								field_radio(w_accept,"reject",false,"");
								/- <tr><td>
								button_submit();
							</f>
							<f validate>
								return true;
							</f>
							<f process>
								glocal bool fail = false;
								if (strcmp(w_accept.c_str(),"accept")==0){
									glocal.status = CONTACT_ACCEPTED;
								}else if (strcmp(w_accept.c_str(),"reject")==0){
									glocal.status = CONTACT_REJECTED;
								}else{
									glocal.fail = true;
									/- Invalid input ???
								}
								if (!glocal.fail){
									<call bod_client_contact_manage>(glocal.con,w_session.c_str(),"",glocal.user.c_str(),glocal.status);
									<f ok>
										if (!success){
											glocal.fail = true;
											htmlprintf ("operation failed: %s<br>\n",msg);
										}else{
											glocal.done = true;
										}
									</f>
									</call>
								}
								fail = glocal.fail;
							</f>
							</call>
							if (glocal.done){
								/- <table border=0><tr><td>&nbsp;&nbsp;&nbsp;<td><table border=0><tr><td>
								/-#I_CONTACTDONE Contact request processed!
								/- <p>
								if (glocal.status == CONTACT_ACCEPTED){
									htmlprintf (MSG_U(I_FROMNOWON,"From now on, you can communicate with user %s<br>\n"),glocal.user.c_str());
									htmlprintf (MSG_U(I_MAKEMEMBER,"You can make user %s member of your groups<br>\n"),glocal.user.c_str());
									/-#I_HEMAKEMEMBER and he can make you member of his groups.
								}
								/- </table></table>
								glocal.webtabs.setstate("");
							}
						}
					}
				</f>
				</call>
			}else if (strcmp(id,"Interests")==0){	// CONF interests
				sethelp("helpinterests",MSG_U(I_HELPINTERESTS,"Interests"));
				<call vframe2h>(40);
				<f left>
					{
						DIV f; f.id(TAB_FORM).print();
						url_self ("add=1",MSG_U(I_NEWINTEREST,"Add interests"));
						/- <br>&nbsp;<br>
					}
					static const string id = "list:interests";
					<call webtable>(ID_INTERESTS,id,"100%",currents[id]);
					<f click>
						glocal unsigned dropmenu = dropmenu;
						glocal unsigned noline = noline;
						<call bod_client_interest_list>(glocal.con,w_session.c_str(),"");
						<f ok>
							if (glocal.noline < users.size() && glocal.dropmenu == MENU_DELETE){
								<call bod_client_interest_unset>(glocal.con,w_session.c_str()
									,users[glocal.noline].name,"");
								<f ok>
								</f>
								</call>
							}
						</f>
						</call>
					</f>
					<f load>
						adddrop_opt (MENU_DELETE,MSG_R(M_DELETE));
						sethead (MSG_U(H_INTEREST,"\tPerson\tSince"));
						<call bod_client_interest_list>(glocal.con,w_session.c_str(),"");
						<f ok>
							unsigned rownum=0;
							for (auto &u:users){
								glocal.webtable.setclickopt (true,"",string_f("user=%u:%s",rownum,u.name));
								string since = format_date(userinfo.dateformat,u.since);
								const char *pt = strchr(u.name,'@');
								if (pt!=NULL){
									// remote user
									string name(u.name,pt-u.name);
									glocal.webtable.setrow("white",rownum,"<img src=https://%s/public/%s/project/mini-photo.jpg>\t%s\t%s"
										,pt+1,name.c_str(),u.name,since.c_str());
								}else if (u.visible){
									glocal.webtable.setrow("white",rownum,"<img src=/public/%s/project/mini-photo.jpg>\t%s\t%s"
										,u.name,u.name,since.c_str());
								}else{
									glocal.webtable.setrow("white",rownum,"<img src=/private.png>\t%s\t%s"
										,u.name,since.c_str());
								}
								rownum++;
							}
						</f>
						</call>
					</f>
					</call>
				</f>
				<f right>
					if (profile_formactive (glocal.webtabs)){
						glocal bool done = false;
						<call form>("interest");
						<f top>
							/- <table border=0><tr><td>&nbsp;&nbsp;&nbsp;<td><table border=0>
							/- <table border=0>
							/- <tr><td><td>
							/-#I_ADDINTEREST <h2>Add more interesting people</h2>
						</f>
						<f bottom>
							/- </table></table>
						</f>
						<f setup>
							field_hidden (w_add);
							/-#I_PEOPLES <tr><td valign=top>Peoples<td>
							field_textarea (w_content,10,60,"");
							/- <tr><td>
							button_submit();
						</f>
						<f validate>
							return true;
						</f>
						<f process>
							glocal string error;
							glocal bool fail = false;
							glocal vector<string> users;
							const char *pt = w_content.c_str();
							while (*pt != '\0'){
								pt = str_skip(pt);
								if (*pt > ' '){
									const char *start = pt;
									while (*pt > ' ') pt++;
									glocal.users.push_back(string(start,pt-start));
								}
							}
							// Check if some are already in the interest list
							<call bod_client_interest_list>(glocal.con,w_session.c_str(),"");
							<f ok>
								for (auto u:users){
									if (find(glocal.users.begin(),glocal.users.end(),u.name)!=glocal.users.end()){
										glocal.error += string_f(" %s",u.name);
										glocal.fail = true;
									}
								}
							</f>
							</call>
							if (!glocal.fail){
								for (auto u:glocal.users){
									glocal const char *user = u.c_str();
									<call bod_client_interest_set>(glocal.con,w_session.c_str(),u,"");
									<f ok>
										if (!success){
											htmlprintf (MSG_U(E_INTERESTSET,"Can't add user %s in interest list: %s<br>\n")
												,glocal.user,msg);
											glocal.fail = true;
										}
									</f>
									</call>
									if (glocal.fail) break;
								}
							}else{
								htmlprintf ("%s<br>%s<br>",MSG_U(E_INTERESTDUP,"These people are already in your interest list"),glocal.error.c_str());
							}
							fail = glocal.fail;
							if (!fail) glocal.webtabs.setstate("");
						</f>
						</call>
					}
				</f>
				</call>
			}else if (strcmp(id,"Account")==0){ // CONF account
				glocal string status = "&nbsp;";
				sethelp("helpaccount",MSG_U(I_HELPACCOUNT,"Account"));
				DIV d("webtable"); d.autoscroll().print();
				<call form>("configaccount");
				<f top>
					/- <table border=0>
					htmlprintf ("<tr><td colspan=2>%s",glocal.status.c_str());
				</f>
				<f bottom>
					/- </table>
				</f>
				<f load>
					<call bod_client_config_read>(glocal.con,w_session.c_str(),"");
					<f ok>
						w_lang = config.lang;
						w_dateformat = string_f("%u",config.dateformat);
						w_public_view = config.public_view;
						w_public_dir = config.public_dir;
						w_anon_messages = config.anon_messages;
					</f>
					</call>
					<call bod_client_info_read>(glocal.con,w_session.c_str(),"");
					<f ok>
						w_publish = info.publish;
						w_bosite = info.bosite_visible;
						w_name = info.fullname;
						w_address1 = info.address1;
						w_address2 = info.address2;
						w_city = info.city;
						w_zipcode = info.zipcode;
						w_state = info.state;
						w_country = info.country;
						w_email = info.email;
						w_phone = info.phone;
						w_fax = info.fax;
						w_website = info.website;
						w_interest = info.interest;
						w_photo = info.photo;
						w_miniphoto = info.mini_photo;
					</f>
					</call>
				</f>
				<f setup>
					{
					DIV d; d.border(1,"gray").paddings(5,5).vpaddings(0,5).print();
					/- <center><font size=+2>
					/-#T_PERSOPREF Personal preferences
					/- </font></center>
					/- <table border=0>
					/-#I_LANG <tr><td>Language<td>
					field_list (w_lang,"");
					field_list_item ("eng",MSG_U(I_ENGLISH,"English"));
					field_list_item ("fr",MSG_U(I_FRENCH,"French"));
					field_list_end();
					/-#I_DATEFORMAT <tr><td>Date format<td>
					field_list(w_dateformat,"");
					field_list_item ("0",MSG_U(I_ENGDATE,"Month DD YYYY HH:MMam/pm"));
					field_list_item ("1",MSG_U(I_ISODATE,"YYYY/MM/DD HH:MM:SS"));
					field_list_end();

					/-#I_ENABLEPUB <tr><td>Enable public view<td>
					field_checkbox (w_public_view,"");
					/-#I_PUBFOLDER <tr><td>Public folder<td>
					field_list (w_public_dir,"");
					field_list_item ("",MSG_U(I_NONE,"--none--"));
					field_list_item ("/",MSG_U(I_ROOTDIR,"root"));
					<call bod_client_listdir>(glocal.con,w_session.c_str(),string_f("/projects/%s/public",userinfo.name.c_str())
						,"",false,0,100);
					<f ok>
						for (auto &f:files){
							if (bolixo_isdir(f.type)){
								glocal.form.field_list_item (f.name,f.name);
							}
						}
					</f>
					</call>
					/-#I_ACCEPTANON <tr><td>Accept anonymous messages<td>
					field_checkbox (w_anon_messages,"");
					/- </table>
					}
					{
					DIV d; d.border(1,"gray").paddings(5,5).vpaddings(0,5).vmargins(5,0).print();
					/- <center><font size=+2>
					/-#T_PUBLISH Public information
					/- </font></center>
					/-#F_PUBLISH Publish to bolixo.org directory
					/- &nbsp;&nbsp;
					field_checkbox (w_publish,"");
					DIV dd; dd.border(1,"lightgray").print();
					/- <table border=0>
					index_field (this,true,3,MSG_U(F_FULLNAME,"Name and surname"),w_name,40);
					index_field (this,true,3,MSG_U(F_ADDRESS1,"Address"),w_address1,40);
					index_field (this,true,3,MSG_U(F_ADDRESS2,"Address"),w_address2,40);
					index_field (this,true,MSG_U(F_CITY,"City"),w_city);
					index_field (this,false,MSG_U(F_STATE,"State"),w_state);
					index_field (this,true,MSG_U(F_COUNTRY,"Country"),w_country);
					index_field (this,false,MSG_U(F_ZIPCODE,"ZIP code"),w_zipcode);
					index_field (this,true,MSG_U(F_EMAIL,"Email"),w_email);
					index_field (this,true,MSG_U(F_PHONE,"Phone"),w_phone);
					index_field (this,false,MSG_U(F_FAX,"Fax"),w_fax);
					/- <tr><td>
					/-#F_PUBLISHSOME Publish
					/- <td colspan=3>
					field_checkbox (w_bosite,"");
					/-#F_PUBBOLIXOSITE your bolixo page
					/-&nbsp;&nbsp;
					field_checkbox (w_photo,"");
					/-#F_YOURPHOTO Your photo
					/-&nbsp;&nbsp;
					field_checkbox (w_miniphoto,"");
					/-#F_YOURMINIPHOTO Your mini photo
					index_field (this,true,MSG_U(F_WEBSITE,"Web site"),w_website);
					/- <tr><td>
					/-#F_INTERESTS Interests
					/- <td colspan=3>
					field_textarea (w_interest,8,70,"");
					/- </table>
					}
					/- <tr><td><br>
					button_submit();
				</f>
				<f validate>
					bool ret = true;
					if (w_bosite.getval() != 0 && w_public_view.getval()==0){
						ret = false;
						/- <font color=red>* </font>
						/-#E_CANTPUBBOSITE You can't publish your bolixo page unless you enable public view
					}
					return ret;
				</f>
				<f process>
					glocal bool fail = false;
					CONFIG config;
					config.lang = w_lang.c_str();
					config.dateformat = atoi(w_dateformat.c_str());
					config.public_view = w_public_view;
					config.public_dir = w_public_dir.c_str();
					config.anon_messages = w_anon_messages;
					<call bod_client_config_write>(glocal.con,w_session.c_str(),"",config);
					<f ok>
						if (!success){
							glocal.fail = true;
							htmlprintf (MSG_U(E_CANTSAVECONFIG,"Can't save configuration: %s\n"),msg);
						}else{
							translat_selectlang (w_lang.c_str());
							glocal.status = MSG_U(I_CONFIGUPDATED,"Configuration updated");
						}
					</f>
					</call>
					USERPUBLICINFO info;
					info.publish = w_publish.getval();
					info.bosite_visible = w_bosite.getval();
					info.fullname = w_name.c_str();
					info.address1 = w_address1.c_str();
					info.address2 = w_address2.c_str();
					info.city = w_city.c_str();
					info.zipcode = w_zipcode.c_str();
					info.state = w_state.c_str();
					info.country = w_country.c_str();
					info.email = w_email.c_str();
					info.phone = w_phone.c_str();
					info.fax = w_fax.c_str();
					info.website = w_website.c_str();
					info.interest = w_interest.c_str();
					info.photo = w_photo.getval();
					info.mini_photo = w_miniphoto.getval();
					<call bod_client_info_write>(glocal.con,w_session.c_str(),"",info);
					<f ok>
						if (!success){
							glocal.fail = true;
							htmlprintf (MSG_U(E_CANTSAVEPUBCONFIG,"Can't save public configurations: %s\n"),msg);
						}
					</f>
					</call>
					fail = glocal.fail;
					keepediting = true;
				</f>
				</call>
			}
		</f>
		</call>
	</f>
	<f step12> // Documentation
		bolixo_title (MSG_R(M_DOCUM),this);
		DIV d("tabs","tab"); d.w(100).print();
		index_doc(glocal.docpointers[SECTION_NONE],section_none);
	</f>
	<f step13>
	</f>
	<f step14>
	</f>
	<f step15>
	</f>
	</call>
}
</mod>

extern "C" void tlmp_initmod()
{
	translat_load ("bolixo");
}

<mod>
extern "C" void webmain()
{
	if (w_test == 1){
		/-ok
		return;
	}
	long long start = fdpass_getnow();
	#ifdef INSTRUMENT
		fprintf (f_instrument,"%Ld --------\n",start);
	#endif
	<call tcpconnect>("unix:","/tmp/stop.sock",1);
	<f init>
	</f>
	<f oneline>
		webmain_real();
		end=true;
	</f>
	<f fail>
		webmain_real();
	</f>
	<f end>
	</f>
	</call>
	long long end = fdpass_getnow();
	glocal long long diff = end - start;
	<call savefile>("/tmp/duration",true);
	<f dowrite>
		struct rusage u;
		if (getrusage(RUSAGE_SELF,&u)==-1){
			fprintf (fout,"syscall getrusage failed: %s\n",strerror(errno));
		}
		fprintf (fout,"%Ld.%06Ld [%lu.%06lu,%lu.%06lu] %s?%s\n"
			,glocal.diff/1000000,glocal.diff%1000000
			,u.ru_utime.tv_sec,u.ru_utime.tv_usec
			,u.ru_stime.tv_sec,u.ru_stime.tv_usec
			,tlmpweb_curpage(),getenv ("QUERY_STRING"));
		return 0;
	</f>
	</call>
}
</mod>

